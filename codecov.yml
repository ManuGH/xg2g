# Codecov Configuration for xg2g
# Documentation: https://docs.codecov.com/docs/codecov-yaml

codecov:
  # Require CI to pass before processing coverage
  require_ci_to_pass: yes

  # Allow 12 hours for reports to be uploaded
  max_report_age: 12h

  # Use strict YAML branch enforcement
  strict_yaml_branch: main

# Coverage calculation settings
coverage:
  # Precision for coverage percentages (2 decimal places)
  precision: 2

  # Round coverage up to nearest precision
  round: up

  # Coverage range (0-100%)
  range: "0..100"

  # Status checks configuration
  status:
    # Project-level coverage (overall project health)
    project:
      default:
        # Target: Maintain current coverage or better
        target: auto
        # Allow up to 0.5% drop without failing
        threshold: 0.5%
        # Only apply to main branch and PRs
        branches:
          - main
        # If coverage report not found, don't fail
        if_not_found: success
        # Only post status on pull requests
        only_pulls: false

      # Minimum acceptable coverage for the project
      minimum:
        target: 55%
        threshold: 0%
        if_not_found: failure
        only_pulls: true

    # Patch-level coverage (new code in PRs)
    patch:
      default:
        # All new code should be tested
        target: 90%
        # Allow small drops for refactoring
        threshold: 5%
        # Only apply to pull requests
        only_pulls: true
        if_not_found: success

      # Core modules require higher coverage
      core:
        target: 95%
        threshold: 2%
        paths:
          - "internal/daemon/**"
          - "internal/api/**"
          - "internal/owi/**"
        only_pulls: true

# Flags for segmenting coverage by test type
flags:
  # Unit tests (fast, focused)
  unittests:
    paths:
      - "internal/"
    carryforward: true
    carryforward_mode: labels

  # Integration tests (slower, end-to-end)
  integration:
    paths:
      - "test/integration/"
    carryforward: true
    carryforward_mode: labels

  # Contract tests (API contract validation)
  contract:
    paths:
      - "test/contract/"
    carryforward: true
    carryforward_mode: labels

# Components for organizing code coverage
component_management:
  default_rules:
    # Default settings for all components
    statuses:
      - type: project
        target: 55%
      - type: patch
        target: 90%

  individual_components:
    # Core daemon (main application logic)
    - component_id: daemon
      name: "Daemon"
      paths:
        - "cmd/daemon/**"
        - "internal/daemon/**"
      statuses:
        - type: project
          target: 60%
        - type: patch
          target: 95%

    # API layer (HTTP endpoints, middleware)
    - component_id: api
      name: "API Layer"
      paths:
        - "internal/api/**"
        - "internal/middleware/**"
      statuses:
        - type: project
          target: 70%
        - type: patch
          target: 95%

    # EPG (Electronic Program Guide)
    - component_id: epg
      name: "EPG Module"
      paths:
        - "internal/epg/**"
      statuses:
        - type: project
          target: 55%
        - type: patch
          target: 90%

    # Playlist generation
    - component_id: playlist
      name: "Playlist"
      paths:
        - "internal/playlist/**"
      statuses:
        - type: project
          target: 60%
        - type: patch
          target: 90%

    # Stream proxy (audio transcoding)
    - component_id: proxy
      name: "Stream Proxy"
      paths:
        - "internal/proxy/**"
        - "internal/transcoder/**"
      statuses:
        - type: project
          target: 50%
        - type: patch
          target: 85%

    # OpenWebInterface client
    - component_id: owi
      name: "OWI Client"
      paths:
        - "internal/owi/**"
      statuses:
        - type: project
          target: 65%
        - type: patch
          target: 90%

# Comment configuration for pull requests
comment:
  # Post coverage report as PR comment
  layout: "reach,diff,flags,components"
  behavior: default
  require_changes: false
  require_base: false
  require_head: true

  # Show files with coverage changes
  show_carryforward_flags: true

# Ignore patterns (files/directories to exclude from coverage)
ignore:
  - "**/*_test.go"
  - "test/**"
  - "docs/**"
  - "cmd/*/main.go"
  - "**/*.pb.go"
  - "**/*_mock.go"
  - "**/*_gen.go"
  - "**/testdata/**"
  - "transcoder/**"  # Rust code, not Go

# GitHub integration settings
github_checks:
  annotations: true

# Notification settings (optional - uncomment to enable)
# slack:
#   url: "secret:SLACK_WEBHOOK"
#   threshold: 1%
#   only_pulls: false
#   message: "Coverage changed for {{owner}}/{{repo}}"
#   branches:
#     - main

# Profiling (for debugging coverage issues)
# profiling:
#   critical_files_paths:
#     - "internal/daemon/**"
#     - "internal/api/**"
