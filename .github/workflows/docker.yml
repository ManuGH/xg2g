name: docker

on:
  push:
    branches: [main]
    tags:
      - "v*"
    paths:
      - Dockerfile
      - "**/*.go"
      - go.mod
      - go.sum
      - .github/workflows/docker.yml
  workflow_dispatch:

concurrency:
  group: repo-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read # Top-level read-only

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # for pushing to GHCR
      id-token: write # for cosign keyless signing
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # Latest stable

      - uses: actions/setup-go@3041dee5d64473ef0bad009d902ffdbccf9d1a33  # Latest stable
        with:
          go-version-file: go.mod
          check-latest: true
          cache: true
        env:
          GOTOOLCHAIN: local

      - name: Verify modules
        run: |
          go mod verify
          git diff --exit-code -- go.mod go.sum

      - name: Verify Go syntax
        run: |
          BUILD_REF="${GITHUB_SHA:-dev}"
          # Pure Go build (CGO disabled)
          echo "âœ… Docker build will handle full compilation"
          # Verify Go syntax
          go build -v -trimpath -mod=vendor -buildvcs=false -ldflags "-X main.Version=${BUILD_REF}" -o /dev/null ./cmd/daemon

      - uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
        id: meta
        with:
          images: ghcr.io/${{ github.repository_owner }}/xg2g
          tags: |
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=ref,event=tag
            type=sha
            type=raw,value=main,enable=${{ github.ref == 'refs/heads/main' }}

      - uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        id: build_alpine
        with:
          context: .
          file: Dockerfile
          push: ${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/') }}
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      - name: Output alpine digest
        if: always()
        run: |
          echo "alpine digest: ${{ steps.build_alpine.outputs.digest }}" | tee -a "$GITHUB_STEP_SUMMARY"

      - name: Install cosign
        if: github.ref == 'refs/heads/main'
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Sign container image (keyless)
        if: github.ref == 'refs/heads/main'
        env:
          DIGEST: ${{ steps.build_alpine.outputs.digest }}
          TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          # Sign all tags for this image
          for tag in ${TAGS}; do
            echo "Signing: ${tag}@${DIGEST}"
            cosign sign --yes "${tag}@${DIGEST}"
          done

      - name: Generate SLSA provenance predicate
        if: github.ref == 'refs/heads/main'
        id: provenance
        run: |
          cat > provenance.json <<EOF
          {
            "builder": {
              "id": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            },
            "buildType": "https://github.com/slsa-framework/slsa/blob/v1.0/levels.md",
            "invocation": {
              "configSource": {
                "uri": "https://github.com/${{ github.repository }}",
                "digest": {"sha1": "${{ github.sha }}"},
                "entryPoint": ".github/workflows/docker.yml"
              }
            },
            "metadata": {
              "buildStartedOn": "${{ github.event.repository.updated_at }}",
              "buildFinishedOn": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "completeness": {
                "parameters": true,
                "environment": false,
                "materials": false
              },
              "reproducible": false
            },
            "materials": [
              {
                "uri": "https://github.com/${{ github.repository }}",
                "digest": {"sha1": "${{ github.sha }}"}
              }
            ]
          }
          EOF
          echo "predicate_file=provenance.json" >> "$GITHUB_OUTPUT"

      - name: Attest SLSA provenance
        if: github.ref == 'refs/heads/main'
        env:
          DIGEST: ${{ steps.build_alpine.outputs.digest }}
          TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          # Attest provenance for the primary tag
          PRIMARY_TAG=$(echo "${TAGS}" | head -n1)
          echo "Attesting provenance for: ${PRIMARY_TAG}@${DIGEST}"
          cosign attest --yes --type slsaprovenance \
            --predicate provenance.json \
            "${PRIMARY_TAG}@${DIGEST}"

  # Disabled: Dockerfile.distroless not yet implemented
  # TODO: Create Dockerfile.distroless for minimal attack surface deployment
  # build-and-push-distroless:
  #   runs-on: ubuntu-latest
  #   needs: build-and-push
  #   ...
