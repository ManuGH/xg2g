name: Chaos Engineering Tests

on:
  # Manual trigger for on-demand chaos testing
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (staging/production)'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      tests:
        description: 'Tests to run (comma-separated: pod-kill,cpu-stress,upstream-timeout)'
        required: true
        default: 'pod-kill,cpu-stress,upstream-timeout'

  # Scheduled nightly run (staging only)
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC every day

env:
  GO_VERSION: '1.25'
  KUBECONFIG: ${{ github.workspace }}/kubeconfig.yaml

jobs:
  chaos-tests:
    name: Resilience Tests
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    permissions:
      contents: read
      id-token: write  # For OIDC authentication with cloud providers

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@d60b41a563ad535c1364609c56962e6929cce1ca # v5.2.1
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Configure kubectl
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_STAGING }}
        run: |
          echo "$KUBE_CONFIG_DATA" | base64 -d > $KUBECONFIG
          chmod 600 $KUBECONFIG
          kubectl cluster-info

      - name: Verify xg2g deployment
        run: |
          kubectl get deployment xg2g -n default
          kubectl get pods -n default -l app=xg2g

      - name: Run pod-kill chaos test
        if: contains(github.event.inputs.tests, 'pod-kill') || github.event_name == 'schedule'
        timeout-minutes: 5
        env:
          NAMESPACE: default
          DEPLOYMENT: xg2g
          HEALTH_URL: http://xg2g.staging.svc.cluster.local:8080/healthz
          PROMETHEUS_URL: http://prometheus.monitoring.svc.cluster.local:9090
        run: |
          bash scripts/chaos/pod-kill.sh

      - name: Run CPU-stress chaos test
        if: contains(github.event.inputs.tests, 'cpu-stress') || github.event_name == 'schedule'
        timeout-minutes: 10
        env:
          NAMESPACE: default
          DEPLOYMENT: xg2g
          STRESS_DURATION: 60
          TARGET_CPU_PERCENT: 80
          PROMETHEUS_URL: http://prometheus.monitoring.svc.cluster.local:9090
        run: |
          bash scripts/chaos/cpu-stress.sh

      - name: Run upstream-timeout chaos test
        if: contains(github.event.inputs.tests, 'upstream-timeout') || github.event_name == 'schedule'
        timeout-minutes: 5
        env:
          TARGET_URL: http://xg2g.staging.svc.cluster.local:8080/api/v1/lineup.json
          TIMEOUT_DURATION: 30
          DELAY_MS: 5000
          PROMETHEUS_URL: http://prometheus.monitoring.svc.cluster.local:9090
        run: |
          bash scripts/chaos/upstream-timeout.sh

      - name: Collect Prometheus metrics
        if: always()
        run: |
          # Query key metrics after chaos tests
          kubectl port-forward -n monitoring svc/prometheus 9090:9090 &
          PF_PID=$!
          sleep 5

          # HTTP request rate
          curl -s "http://localhost:9090/api/v1/query?query=sum(rate(http_requests_total[5m]))" \
            | jq -r '.data.result[0].value[1]' > metrics-request-rate.txt || echo "N/A" > metrics-request-rate.txt

          # Error rate
          curl -s "http://localhost:9090/api/v1/query?query=sum(rate(http_requests_total{status=~\"5..\"}[5m]))" \
            | jq -r '.data.result[0].value[1]' > metrics-error-rate.txt || echo "N/A" > metrics-error-rate.txt

          # Circuit breaker state
          curl -s "http://localhost:9090/api/v1/query?query=openwebif_circuit_breaker_state" \
            | jq -r '.data.result[0].value[1]' > metrics-circuit-breaker.txt || echo "N/A" > metrics-circuit-breaker.txt

          kill $PF_PID || true

          echo "Post-Chaos Metrics:"
          echo "  Request rate: $(cat metrics-request-rate.txt) req/sec"
          echo "  Error rate: $(cat metrics-error-rate.txt) req/sec"
          echo "  Circuit breaker: $(cat metrics-circuit-breaker.txt)"

      - name: Collect pod logs
        if: always()
        run: |
          kubectl logs -n default -l app=xg2g --tail=500 --prefix=true \
            > chaos-test-logs.txt || echo "Failed to collect logs"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chaos-test-results-${{ github.run_id }}
          path: |
            chaos-test-logs.txt
            metrics-*.txt
          retention-days: 30

      - name: Check cluster health
        if: always()
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployment xg2g -n default -o wide

          echo ""
          echo "=== Pod Status ==="
          kubectl get pods -n default -l app=xg2g

          echo ""
          echo "=== Recent Events ==="
          kubectl get events -n default --sort-by='.lastTimestamp' --field-selector type=Warning | tail -10

      - name: Notify on failure
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [[ -n "$SLACK_WEBHOOK" ]]; then
            curl -X POST "$SLACK_WEBHOOK" \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "❌ Chaos Engineering Tests Failed",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Chaos Engineering Tests Failed*\n\nEnvironment: ${{ github.event.inputs.environment || '"'"'staging'"'"' }}\nRun: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                    }
                  }
                ]
              }'
          fi

  verify-recovery:
    name: Verify System Recovery
    runs-on: ubuntu-latest
    needs: chaos-tests
    if: always()
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Configure kubectl
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_STAGING }}
        run: |
          echo "$KUBE_CONFIG_DATA" | base64 -d > $KUBECONFIG
          chmod 600 $KUBECONFIG

      - name: Wait for system stabilization
        run: |
          echo "Waiting 60s for system to stabilize after chaos tests..."
          sleep 60

      - name: Health check
        run: |
          # Check if pods are healthy
          READY=$(kubectl get deployment xg2g -n default -o jsonpath='{.status.readyReplicas}')
          DESIRED=$(kubectl get deployment xg2g -n default -o jsonpath='{.spec.replicas}')

          if [[ "$READY" == "$DESIRED" && "$READY" -gt 0 ]]; then
            echo "✅ All pods healthy ($READY/$DESIRED ready)"
          else
            echo "❌ System not fully recovered ($READY/$DESIRED ready)"
            exit 1
          fi

      - name: Endpoint smoke test
        run: |
          # Port forward to test endpoint
          kubectl port-forward -n default svc/xg2g 8080:8080 &
          PF_PID=$!
          sleep 5

          # Test health endpoint
          if curl -sf http://localhost:8080/healthz -o /dev/null; then
            echo "✅ Health endpoint responsive"
          else
            echo "❌ Health endpoint failed"
            kill $PF_PID || true
            exit 1
          fi

          # Test API endpoint
          if curl -sf http://localhost:8080/api/v1/lineup.json -o /dev/null; then
            echo "✅ API endpoint responsive"
          else
            echo "❌ API endpoint failed"
            kill $PF_PID || true
            exit 1
          fi

          kill $PF_PID || true

      - name: Verify metrics collection
        run: |
          kubectl port-forward -n monitoring svc/prometheus 9090:9090 &
          PF_PID=$!
          sleep 5

          # Check if metrics are being collected
          RATE=$(curl -s "http://localhost:9090/api/v1/query?query=sum(rate(http_requests_total[1m]))" \
            | jq -r '.data.result[0].value[1]' || echo "0")

          kill $PF_PID || true

          if [[ "$RATE" != "0" && "$RATE" != "N/A" ]]; then
            echo "✅ Metrics collection active (${RATE} req/sec)"
          else
            echo "⚠️  No metrics traffic detected (may be expected)"
          fi

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "═══════════════════════════════════════════════"
          echo "Chaos Engineering Test Suite Complete"
          echo "═══════════════════════════════════════════════"
          echo "Environment: ${{ github.event.inputs.environment || 'staging' }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Tests: ${{ github.event.inputs.tests || 'all' }}"
          echo ""
          echo "Next Steps:"
          echo "  1. Review logs in artifacts"
          echo "  2. Check Grafana dashboards"
          echo "  3. Investigate any warnings"
          echo "═══════════════════════════════════════════════"
