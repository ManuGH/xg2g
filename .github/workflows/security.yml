name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Weekly security scan every Monday at 3 AM UTC
    - cron: "0 3 * * 1"

permissions:
  contents: read
  security-events: write

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25"
          cache: true

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run vulnerability check
        run: |
          echo "ðŸ” Scanning for known CVE vulnerabilities..."
          govulncheck ./...

      - name: Run security-focused tests
        run: |
          echo "ðŸ§ª Running security test suite..."
          go test ./... -race -count=1 -tags security

      - name: Validate input sanitization
        run: |
          echo "ðŸ›¡ï¸ Checking input validation patterns..."
          # Check for potential security anti-patterns
          ! grep -r "err\.Error()" internal/ || (echo "âŒ Found err.Error() exposure" && exit 1)
          ! grep -r "Access-Control-Allow-Origin.*\*" internal/ || (echo "âŒ Found permissive CORS" && exit 1)
          grep -r "filepath\.Abs" internal/jobs/ || (echo "âŒ Missing path validation" && exit 1)
          echo "âœ… Input validation checks passed"

      - name: Docker security baseline
        run: |
          echo "ðŸ³ Docker security validation..."
          # Check Dockerfile for security best practices
          grep "USER.*[0-9]" Dockerfile || (echo "âŒ Missing non-root user" && exit 1)
          grep "alpine:" Dockerfile || (echo "âŒ Not using minimal base image" && exit 1)
          grep "adduser.*-D" Dockerfile || (echo "âŒ Missing secure user creation" && exit 1)
          echo "âœ… Container security checks passed"

      - name: Security summary
        run: |
          echo "## ðŸ›¡ï¸ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No known CVE vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Race condition tests passed" >> $GITHUB_STEP_SUMMARY  
          echo "- âœ… Input validation patterns verified" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Container security baseline met" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Security Status**: ðŸŸ¢ PRODUCTION READY" >> $GITHUB_STEP_SUMMARY
