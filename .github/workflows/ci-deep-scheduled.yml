name: CI Deep Scheduled

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *" # nightly (UTC)
    - cron: "0 3 * * 0" # weekly (UTC, Sunday)

permissions:
  contents: read

concurrency:
  group: repo-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  GOTOOLCHAIN: auto
  TZ: UTC
  NIGHTLY_CRON: "0 2 * * *"
  WEEKLY_CRON: "0 3 * * 0"

jobs:
  nightly-race:
    name: nightly-race
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '0 2 * * *'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Setup Go
        uses: actions/setup-go@a5f9b05d2d216f63e13859e0d847461041025775
        with:
          go-version-file: go.mod
          check-latest: true
          cache: true
          cache-dependency-path: go.sum
        env:
          GOTOOLCHAIN: auto

      - name: Run race suite
        run: |
          set -euo pipefail
          go test -race -count=1 ./... 2>&1 | tee nightly-race.log

      - name: Upload race logs on failure
        if: failure()
        uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5 # v4.4.3
        with:
          name: nightly-race-logs
          path: nightly-race.log
          if-no-files-found: ignore
          retention-days: 14

  nightly-integration:
    name: nightly-integration
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '0 2 * * *'
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Setup Go
        uses: actions/setup-go@a5f9b05d2d216f63e13859e0d847461041025775
        with:
          go-version-file: go.mod
          check-latest: true
          cache: true
          cache-dependency-path: go.sum
        env:
          GOTOOLCHAIN: auto

      - name: Run integration and invariants (fail-fast)
        run: |
          set -euo pipefail
          go test -count=1 -failfast ./test/integration/... ./test/invariants/... 2>&1 | tee nightly-integration.log

      - name: Upload integration logs on failure
        if: failure()
        uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5 # v4.4.3
        with:
          name: nightly-integration-logs
          path: nightly-integration.log
          if-no-files-found: ignore
          retention-days: 14

  weekly-security-deep:
    name: weekly-security-deep
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '0 3 * * 0'
    runs-on: ubuntu-latest
    timeout-minutes: 75
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Setup Go
        uses: actions/setup-go@a5f9b05d2d216f63e13859e0d847461041025775
        with:
          go-version-file: go.mod
          check-latest: true
          cache: true
          cache-dependency-path: go.sum
        env:
          GOTOOLCHAIN: auto

      - name: Install security tools
        run: |
          set -euo pipefail
          go install golang.org/x/vuln/cmd/govulncheck@v1.1.4
          go install github.com/securego/gosec/v2/cmd/gosec@v2.22.11

      - name: Run security scanners
        run: |
          set +e
          set -u -o pipefail
          govulncheck -tags=nogpu -format json ./... > govulncheck.json 2> govulncheck.stderr
          GOVULN_EXIT=$?
          gosec \
            -fmt=sarif \
            -out=gosec.sarif \
            -severity=high \
            -tags=nogpu \
            -exclude-generated \
            -exclude-dir=test \
            -exclude-dir=internal/test \
            -exclude-dir=internal/api \
            -exclude-dir=.github \
            -exclude-dir=vendor \
            ./... 2> gosec.stderr
          GOSEC_EXIT=$?

          if [ "$GOVULN_EXIT" -ne 0 ] || [ "$GOSEC_EXIT" -ne 0 ]; then
            exit 1
          fi

      - name: Upload security reports on failure
        if: failure()
        uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5 # v4.4.3
        with:
          name: weekly-security-reports
          path: |
            govulncheck.json
            govulncheck.stderr
            gosec.sarif
            gosec.stderr
          if-no-files-found: ignore
          retention-days: 14

  weekly-governance-deep:
    name: weekly-governance-deep
    needs: [nightly-race, nightly-integration, weekly-security-deep]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 75
    steps:
      - name: Select governance mode
        id: mode
        env:
          EVENT_NAME: ${{ github.event_name }}
          EVENT_SCHEDULE: ${{ github.event.schedule }}
          WEEKLY_CRON: ${{ env.WEEKLY_CRON }}
        run: |
          set -euo pipefail
          RUN_GOVERNANCE=false
          if [ "$EVENT_NAME" = "workflow_dispatch" ] || [ "$EVENT_SCHEDULE" = "$WEEKLY_CRON" ]; then
            RUN_GOVERNANCE=true
          fi
          echo "run_governance=$RUN_GOVERNANCE" >> "$GITHUB_OUTPUT"

      - name: Checkout
        if: steps.mode.outputs.run_governance == 'true'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Setup Go
        if: steps.mode.outputs.run_governance == 'true'
        uses: actions/setup-go@a5f9b05d2d216f63e13859e0d847461041025775
        with:
          go-version-file: go.mod
          check-latest: true
          cache: true
          cache-dependency-path: go.sum
        env:
          GOTOOLCHAIN: auto

      - name: Setup Node
        if: steps.mode.outputs.run_governance == 'true'
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: webui/package-lock.json

      - name: Run governance deep checks
        id: governance
        if: steps.mode.outputs.run_governance == 'true'
        continue-on-error: true
        run: |
          set +e
          set -u -o pipefail

          EXIT=0

          NEW_JSX=$(find webui/src -type f -name '*.jsx' || true)
          if [ -n "$NEW_JSX" ]; then
            echo "❌ New .jsx files detected:"
            echo "$NEW_JSX"
            EXIT=1
          fi

          LEGACY_IMPORTS=$(grep -RIn "from ['\"].*\\.\\./client[^-]" webui/src/ 2>/dev/null || true)
          if [ -n "$LEGACY_IMPORTS" ]; then
            echo "❌ Legacy client imports detected:"
            echo "$LEGACY_IMPORTS"
            EXIT=1
          fi

          (
            cd webui
            npm ci
            npm run build
          )
          BUILD_EXIT=$?
          if [ "$BUILD_EXIT" -ne 0 ]; then
            EXIT=1
          fi

          echo "exit_code=$EXIT" >> "$GITHUB_OUTPUT"
          exit "$EXIT"

      - name: Summary (Job / Command / Exit)
        id: summary
        env:
          RACE_RESULT: ${{ needs.nightly-race.result }}
          INTEGRATION_RESULT: ${{ needs.nightly-integration.result }}
          SECURITY_RESULT: ${{ needs.weekly-security-deep.result }}
          RUN_GOVERNANCE: ${{ steps.mode.outputs.run_governance }}
          GOV_OUTCOME: ${{ steps.governance.outcome }}
          GOV_EXIT: ${{ steps.governance.outputs.exit_code }}
        run: |
          set -euo pipefail

          map_exit() {
            case "$1" in
              success) echo "0" ;;
              skipped) echo "SKIP" ;;
              *) echo "1" ;;
            esac
          }

          RACE_EXIT="$(map_exit "$RACE_RESULT")"
          INTEGRATION_EXIT="$(map_exit "$INTEGRATION_RESULT")"
          SECURITY_EXIT="$(map_exit "$SECURITY_RESULT")"

          GOV_RESULT="skipped"
          GOV_EXIT_DISPLAY="SKIP"
          if [ "$RUN_GOVERNANCE" = "true" ]; then
            if [ "$GOV_OUTCOME" = "success" ]; then
              GOV_RESULT="success"
              GOV_EXIT_DISPLAY="0"
            else
              GOV_RESULT="failure"
              GOV_EXIT_DISPLAY="${GOV_EXIT:-1}"
            fi
          fi

          {
            echo "## Deep Suite Summary"
            echo ""
            echo "| Job | Command | Result | Exit |"
            echo "|---|---|---:|---:|"
            echo "| nightly-race | \`go test -race -count=1 ./...\` | $RACE_RESULT | $RACE_EXIT |"
            echo "| nightly-integration | \`go test -count=1 -failfast ./test/integration/... ./test/invariants/...\` | $INTEGRATION_RESULT | $INTEGRATION_EXIT |"
            echo "| weekly-security-deep | \`govulncheck -tags=nogpu ./... && gosec -severity=high ... ./...\` | $SECURITY_RESULT | $SECURITY_EXIT |"
            echo "| weekly-governance-deep | \`jsx/legacy-import guards + (cd webui && npm ci && npm run build)\` | $GOV_RESULT | $GOV_EXIT_DISPLAY |"
          } >> "$GITHUB_STEP_SUMMARY"

          FAILED=0
          for RESULT in "$RACE_RESULT" "$INTEGRATION_RESULT" "$SECURITY_RESULT"; do
            case "$RESULT" in
              success|skipped) ;;
              *) FAILED=1 ;;
            esac
          done

          if [ "$GOV_RESULT" = "failure" ]; then
            FAILED=1
          fi

          echo "failed=$FAILED" >> "$GITHUB_OUTPUT"

      - name: Fail when deep suite contains failures
        if: steps.summary.outputs.failed == '1'
        run: exit 1
