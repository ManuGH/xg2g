name: lint-and-validate

on:
  pull_request:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
        with:
          go-version-file: go.mod

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.x"

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit
        uses: pre-commit/action@2c7b3805fd2a0fd8c1884dcaebf91fc102a13ecd # v3.0.1

  validate-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
        with:
          go-version-file: go.mod

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.x"

      - name: Install check-jsonschema
        run: pip install check-jsonschema

      - name: Validate configs against JSON Schema
        run: |
          set -euo pipefail
          check-jsonschema --schemafile docs/config.schema.json config.example.yaml
          find internal/config/testdata -name 'valid*.yaml' -maxdepth 1 -type f -print0 | xargs -0 -I{} check-jsonschema --schemafile docs/config.schema.json {}
          if [ -d examples ]; then find examples -name '*.ya?ml' -type f -print0 | xargs -0 -I{} check-jsonschema --schemafile docs/config.schema.json {}; fi

      - name: Generate config docs from schema
        run: go run ./tools/schema-docs ./docs/config.schema.json ./docs/config.md

      - name: Upload generated docs
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: config-docs
          path: docs/config.md
          retention-days: 30

      - name: Build validate
        run: go build -o validate ./cmd/validate

      - name: Validate example configs
        run: |
          set -euo pipefail
          if [ -f config.yaml ]; then ./validate -f config.yaml; fi
          find internal/config/testdata -name 'valid*.yaml' -maxdepth 1 -type f -print0 | xargs -0 -I{} ./validate -f {}
          if [ -d examples ]; then find examples -name '*.ya?ml' -type f -print0 | xargs -0 -I{} ./validate -f {}; fi
