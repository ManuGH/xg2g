name: CI Nightly

on:
  workflow_dispatch:
  schedule:
    - cron: "17 2 * * *" # Daily at 02:17 UTC

permissions:
  contents: read

concurrency:
  group: ci-nightly-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci-nightly:
    name: Nightly Gates (Deep & Expensive)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      GOTOOLCHAIN: local
      TZ: UTC

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Verify Go toolchain policy
        run: ./scripts/check-go-toolchain.sh

      - name: Setup Go
        uses: actions/setup-go@3041dee5d64473ef0bad009d902ffdbccf9d1a33 # v6
        with:
          go-version-file: go.mod
          check-latest: true
          cache: true
        env:
          GOTOOLCHAIN: local

      - name: Install golangci-lint (built with runner Go)
        run: |
          set -euo pipefail
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.8.0
          golangci-lint --version

      - name: Setup Node for OpenAPI + Markdown lint
        uses: actions/setup-node@1d42962bbd92a94ed090950669d6739985926c0d # v6
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: webui/package-lock.json

      - name: Lint OpenAPI (nightly)
        run: |
          set -euo pipefail
          npx --yes @redocly/cli@1.31.0 lint api/openapi.yaml --format=stylish | tee /tmp/openapi-lint.txt

      - name: Lint Markdown (nightly)
        run: |
          set -euo pipefail
          npx --yes markdownlint-cli2@0.14.0 "docs/**/*.md" ".github/**/*.md" "*.md"

      - name: Run nightly gates
        run: make ci-nightly
