name: CI (v2)

on:
  workflow_dispatch:
  schedule:
    - cron: "17 2 * * *" # Daily at 02:17 UTC

permissions:
  contents: read

concurrency:
  group: ci-v2-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Job 1: Unit Tests (Fast, Stub Transcoder, Always Runs)
  # ============================================================================
  unit-tests:
    name: Unit Tests (Stub Transcoder)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5 # v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Verify modules
        run: |
          set -euo pipefail
          go mod tidy
          go mod download
          go mod verify
          git diff --exit-code -- go.mod go.sum

      - name: Setup Node for WebUI
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: webui/package-lock.json

      - name: Build WebUI
        run: |
          set -euo pipefail
          cd webui
          npm ci
          npm run generate-client
          npm run build
          mkdir -p ../internal/api/dist
          cp -r dist/* ../internal/api/dist/

      - name: Build (stub transcoder)
        run: |
          set -euo pipefail
          echo "üîç Building with stub transcoder (no Rust dependency)..."
          go build -v -trimpath -mod=readonly -buildvcs=false -tags=nogpu -o /dev/null ./cmd/daemon
          go build -v -trimpath -mod=readonly -buildvcs=false -o /dev/null ./cmd/validate
          echo "‚úÖ Build successful"

      - name: Run unit tests (via make test)
        run: make test

      - name: Run unit tests with race detector
        run: |
          set -euo pipefail
          go test -v -race -tags=nogpu -coverprofile=coverage.out -covermode=atomic ./...

      - name: Generate coverage report
        run: |
          set -euo pipefail
          COV=$(go tool cover -func=coverage.out | awk '/total:/ {print $3}')
          echo "## Coverage Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Total Coverage:** ${COV}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Top Packages" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          go tool cover -func=coverage.out | grep -E '^github.com/ManuGH/xg2g' | sort -k3 -rn | head -20 >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Upload coverage
        uses: actions/upload-artifact@v4 # v5
        with:
          name: coverage-unit-tests
          path: coverage.out
          retention-days: 14

  # ============================================================================
  # Job 2: Schema Validation Tests (Requires check-jsonschema)
  # ============================================================================
  schema-validation:
    name: Schema Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Setup Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.x"

      - name: Install check-jsonschema
        run: |
          python -m venv .venv
          . .venv/bin/activate
          pip install check-jsonschema==0.31.0

      - name: Run schema tests (via make test-schema)
        run: make test-schema

      - name: Validate configs with check-jsonschema
        run: |
          set -euo pipefail
          . .venv/bin/activate
          check-jsonschema --schemafile docs/guides/config.schema.json config.example.yaml
          find internal/config/testdata -name 'valid*.yaml' -maxdepth 1 -type f -print0 | \
            xargs -0 -I{} check-jsonschema --schemafile docs/guides/config.schema.json {}

      - name: Build validate tool
        run: go build -o bin/validate ./cmd/validate

      - name: Validate configs with CLI tool
        run: |
          set -euo pipefail
          find internal/config/testdata -name 'valid*.yaml' -maxdepth 1 -type f -print0 | \
            xargs -0 -I{} ./bin/validate -f {}

  # ============================================================================
  # Job 3: Transcoder Tests (Optional, Rust/CGO Required)
  # Runs on: schedule (nightly) or manual workflow_dispatch
  # ============================================================================
  transcoder-tests:
    name: Transcoder Tests (Rust FFI)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Only run on schedule or manual trigger (not on every PR)
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5 # v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@6d9817901c499d6b02debbb57edb38d33daa680b # stable
        with:
          toolchain: stable

      - name: Setup Node for WebUI
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: webui/package-lock.json

      - name: Build WebUI
        run: |
          set -euo pipefail
          cd webui
          npm ci
          npm run build
          mkdir -p ../internal/api/dist
          cp -r dist/* ../internal/api/dist/

      - name: Cache Rust dependencies
        uses: actions/cache@v4 # v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            transcoder/target/
          key: ${{ runner.os }}-cargo-v2-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-v2-

      - name: Install FFmpeg development headers
        run: |
          sudo apt-get update
          sudo apt-get install -y libavcodec-dev libavformat-dev libavutil-dev libswresample-dev libswscale-dev pkg-config

      - name: Build Rust transcoder library
        run: |
          rm -rf transcoder/target
          make build-rust
          echo "üìÇ Listing build artifacts:"
          ls -R transcoder/target/release/

      - name: Run transcoder tests (via make test-transcoder)
        run: make test-transcoder

      - name: Upload Rust artifacts
        uses: actions/upload-artifact@v4 # v5
        with:
          name: rust-library
          path: transcoder/target/release/libxg2g_transcoder.a
          retention-days: 7

  # ============================================================================
  # Job 4: Linting (Go, Markdown, OpenAPI)
  # ============================================================================
  lint:
    name: Lint (Go, Markdown, OpenAPI)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5 # v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Setup Node for WebUI
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: webui/package-lock.json

      - name: Build WebUI
        run: |
          set -euo pipefail
          cd webui
          npm ci
          npm run build
          mkdir -p ../internal/api/dist
          cp -r dist/* ../internal/api/dist/

      - name: Install golangci-lint
        run: |
          set -euo pipefail
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.5.0
          golangci-lint --version

      - name: Run golangci-lint
        run: golangci-lint run --timeout=5m --verbose --build-tags=nogpu ./...

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Lint OpenAPI
        run: |
          set -euo pipefail
          npx --yes @redocly/cli@latest lint api/openapi.yaml --format=stylish | tee /tmp/openapi-lint.txt

      - name: Lint Markdown
        continue-on-error: true
        run: |
          set -euo pipefail
          npx --yes markdownlint-cli2 "docs/**/*.md" ".github/**/*.md" "*.md"

      - name: Upload OpenAPI lint report
        if: always()
        uses: actions/upload-artifact@v4 # v5
        with:
          name: openapi-lint
          path: /tmp/openapi-lint.txt
          retention-days: 14

  # ============================================================================
  # Job 5: Integration Tests (Stub + Daemon)
  # ============================================================================
  integration-tests:
    name: Integration Tests (Daemon + Stub OpenWebIF)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [unit-tests] # Only run after unit tests pass

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5 # v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Setup Node for WebUI
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: webui/package-lock.json

      - name: Build WebUI
        run: |
          set -euo pipefail
          cd webui
          npm ci
          npm run build
          mkdir -p ../internal/api/dist
          cp -r dist/* ../internal/api/dist/

      - name: Build daemon (stub transcoder)
        run: |
          set -euo pipefail
          BUILD_REF="${GITHUB_SHA:-dev}"
          go build -v -trimpath -mod=readonly -buildvcs=false -tags=nogpu \
            -ldflags "-X main.version=${BUILD_REF}" \
            -o bin/xg2g ./cmd/daemon

          echo "üîç Verifying version injection..."
          ./bin/xg2g --version
          if ! ./bin/xg2g --version | grep -q "${BUILD_REF}"; then
            echo "‚ùå Version mismatch: Expected connection to contain '${BUILD_REF}'"
            exit 1
          fi
          echo "‚úÖ Version verified"
          echo "‚úÖ Daemon built successfully"

      - name: Run smoke test (includes integration validation)
        run: |
          set -euo pipefail
          echo "üß™ Running smoke test..."
          make smoke-test

  # ============================================================================
  # Job 6: Reproducible Build Check
  # ============================================================================
  reproducible-build:
    name: Reproducible Build Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    container:
      image: golang:1.25-trixie
      env:
        CGO_ENABLED: 0
    env:
      TZ: UTC
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set SOURCE_DATE_EPOCH
        run: |
          set -eu
          apt-get update && apt-get install -y git nodejs npm
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          SOURCE_DATE_EPOCH="$(git log -1 --pretty=%ct)"
          echo "SOURCE_DATE_EPOCH=${SOURCE_DATE_EPOCH}" >> "$GITHUB_ENV"
          echo "Using SOURCE_DATE_EPOCH=${SOURCE_DATE_EPOCH}"

      - name: Setup Go Deps
        run: go mod download

      - name: Build WebUI
        run: |
          set -eu
          cd webui
          npm ci
          npm run generate-client
          npm run build
          mkdir -p ../internal/api/dist
          cp -r dist/* ../internal/api/dist/

      - name: Build #1 (reference)
        run: |
          set -eu
          mkdir -p bin
          make build-repro
          sha256sum bin/xg2g > /tmp/expected.sha256

      - name: Build #2 (must match)
        run: |
          set -eu
          rm -rf bin
          make build-repro
          sha256sum bin/xg2g | diff - /tmp/expected.sha256 || ( \
            echo "‚ùå Binary hashes differ!" && \
            apt-get update && apt-get install -y xxd && \
            xxd bin/xg2g > /tmp/build2.hex && \
            make build-repro && \
            xxd bin/xg2g > /tmp/build3.hex && \
            echo "Diffing build2 vs build3:" && \
            diff -u /tmp/build2.hex /tmp/build3.hex | head -n 50 && \
            exit 1 \
          )

      - name: Upload reproducible binary
        uses: actions/upload-artifact@v4 # v5
        with:
          name: reproducible-daemon
          path: bin/xg2g
          retention-days: 7

  # ============================================================================
  # Summary Job (Always Runs)
  # ============================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs:
      [
        unit-tests,
        schema-validation,
        lint,
        integration-tests,
        reproducible-build,
      ]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "## CI Pipeline Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Job | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Schema Validation | ${{ needs.schema-validation.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Lint | ${{ needs.lint.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Reproducible Build | ${{ needs.reproducible-build.result }} |" >> "$GITHUB_STEP_SUMMARY"

      - name: Fail if any required job failed
        if: |
          needs.unit-tests.result == 'failure' ||
          needs.schema-validation.result == 'failure' ||
          needs.lint.result == 'failure' ||
          needs.integration-tests.result == 'failure' ||
          needs.reproducible-build.result == 'failure'
        run: |
          echo "‚ùå One or more required CI jobs failed"
          exit 1
