name: CI Nightly

on:
  schedule:
    - cron: "17 2 * * *"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: repo-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  ci-nightly:
    name: Nightly Gates (Deep & Expensive)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      GOTOOLCHAIN: auto
      TZ: UTC

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Verify Go toolchain policy
        run: ./scripts/check-go-toolchain.sh

      - name: Setup Go
        uses: actions/setup-go@a5f9b05d2d216f63e13859e0d847461041025775 # v6
        with:
          go-version-file: go.mod
          check-latest: true
          cache: true
        env:
          GOTOOLCHAIN: auto

      - name: Install golangci-lint (built with runner Go)
        run: |
          set -euo pipefail
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.8.0
          golangci-lint --version

      - name: Setup Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: webui/package-lock.json

      - name: Build WebUI assets (required for embed contract)
        run: |
          set -euo pipefail
          cd webui
          npm ci
          npx vite build
          cd ..
          rm -rf internal/control/http/dist
          mkdir -p internal/control/http/dist
          cp -R webui/dist/. internal/control/http/dist/

      - name: Install ffmpeg
        run: |
          set -euo pipefail
          if command -v ffmpeg >/dev/null 2>&1; then
            echo "ffmpeg already installed on runner"
          else
            sudo apt-get update
            sudo apt-get install -y ffmpeg
          fi
          ffmpeg -version

      - name: Run nightly gates
        run: make ci-nightly

  nightly-doc-lint:
    name: Nightly Spec/Docs Lint
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      TZ: UTC

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Setup Node for OpenAPI + Markdown lint
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: webui/package-lock.json

      - name: Lint OpenAPI (nightly)
        run: |
          set -euo pipefail
          npx --yes @redocly/cli@1.31.0 lint api/openapi.yaml --format=stylish | tee /tmp/openapi-lint.txt

      - name: Lint Markdown (nightly)
        run: |
          set -euo pipefail
          npx --yes markdownlint-cli2@0.14.0 "docs/**/*.md" ".github/**/*.md" "*.md"
