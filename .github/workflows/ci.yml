name: CI

on:
  workflow_dispatch:
  schedule:
    - cron: "17 2 * * *"
  push:
    branches: [main]
  pull_request:
    branches: [main]
    paths:
      - "**/*.go"
      - go.mod
      - go.sum
      - .github/workflows/ci.yml
      - "webui/**"
      - "api/openapi.yaml"
      - "internal/api/**"
      - "internal/control/http/v3/**"

permissions:
  contents: read
  # Optional: Allow writing security events if needed (e.g. for sarif upload)
  # security-events: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      GOTOOLCHAIN: local
      TZ: UTC

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Token URL gate
        run: |
          set -euo pipefail
          if git grep -n -i -E '(\?|&)(token|access_token|auth|jwt|bearer)=' -- . ':!vendor'; then
            echo "‚ùå denylisted auth-like query key found in URL parameters"
            exit 1
          fi
          echo "‚úÖ token URL gate passed"

      - name: Verify Go toolchain policy
        run: ./scripts/check-go-toolchain.sh

      - name: Set Reproducible Build Headers
        run: echo "SOURCE_DATE_EPOCH=$(git log -1 --pretty=%ct)" >> "$GITHUB_ENV"

      - name: Setup Go
        uses: actions/setup-go@3041dee5d64473ef0bad009d902ffdbccf9d1a33 # v6
        with:
          go-version-file: go.mod
          check-latest: true
          cache: true
        env:
          GOTOOLCHAIN: local

      - name: Verify modules
        run: |
          set -euo pipefail
          go mod verify
          git diff --exit-code -- go.mod go.sum

      - name: Verify config surfaces (Drift Gate)
        run: |
          set -euo pipefail
          make verify-config

      - name: Setup Node for WebUI
        uses: actions/setup-node@1d42962bbd92a94ed090950669d6739985926c0d # v6
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: webui/package-lock.json

      - name: Clean Build Artifacts
        run: |
          set -euo pipefail
          make clean

      - name: Generate API Client
        run: |
          set -euo pipefail
          cd webui
          npm ci
          npm run generate-client

      - name: Verify Client is Up-to-Date (Contract Test)
        run: |
          set -euo pipefail
          if [[ -n $(git status --porcelain webui/src/client-ts) ]]; then
            echo "‚ùå Error: helper 'webui/src/client-ts' is out of sync with openapi.yaml"
            echo "Please run 'npm run generate-client' locally and commit the changes."
            git status webui/src/client-ts
            git diff webui/src/client-ts
            exit 1
          else
            echo "‚úÖ Client matches OpenAPI spec"
          fi

      - name: "CTO Gate: Hermetic Code Generation"
        run: |
          chmod +x scripts/ci/ctogate_hermetic_codegen.sh
          ./scripts/ci/ctogate_hermetic_codegen.sh .github/workflows/ci.yml

      - name: Verify OpenAPI server codegen is up-to-date (v3 - single source)
        run: |
          set -euo pipefail
          make generate
          git diff --exit-code -- internal/api/server_gen.go internal/control/http/v3/server_gen.go
          # Verify single source of truth
          if [ -f internal/control/http/v3/openapi.yaml ]; then
            echo "‚ùå Duplicate spec found. Use api/openapi.yaml as single source."
            exit 1
          fi
          echo "‚úÖ Single OpenAPI source verified"

      - name: Verify WebUI Contract (Gate)
        run: ./scripts/ci-contract-gate.sh

      - name: Build WebUI
        run: |
          set -euo pipefail
          cd webui
          # CI owns installation (deterministic)
          npm ci
          npm run build
          # Secure Copy to internal/control/http/dist (matches ui.go embed path)
          rm -rf ../internal/control/http/dist
          mkdir -p ../internal/control/http/dist
          cp -R dist/. ../internal/control/http/dist/
          # Sanity Check (index.html is the contract)
          test -f ../internal/control/http/dist/index.html || (echo "‚ùå index.html missing" && exit 1)

          # Debug: Log Integrity to Summary
          FILES="$(find ../internal/control/http/dist -type f | wc -l | tr -d ' ')"
          IDXHASH="$(sha256sum ../internal/control/http/dist/index.html | awk '{print $1}')"
          {
            echo "### WebUI Build Integrity"
            echo "- **Files**: ${FILES}"
            echo "- **Index Hash**: ${IDXHASH}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Build (Pure Go - No CGO)
        run: |
          set -euo pipefail
          # Pure Go build (no CGO, no GPU transcoding).
          echo "‚úÖ Building pure Go daemon..."

          # Verify Go compilation succeeds
          echo "üîç Verifying build compiles..."
          go build -v -trimpath -mod=vendor -buildvcs=false -o /dev/null ./cmd/daemon
          echo "‚úÖ Build successful"

      - name: Unit tests
        env:
          CGO_ENABLED: 0
        run: |
          set -euo pipefail
          # Pure Go tests (no CGO required)
          go test -v -coverprofile=coverage.out -covermode=atomic "$(go list ./... | grep -v '/test$')"

      - name: "Hermetic Build Proof (Adversarial-Grade)"
        env:
          # Block all network escape hatches
          GOPROXY: "off"
          GOSUMDB: "off"
          GOVCS: "*:off" # No VCS network fetches
          GOTOOLCHAIN: "local" # No toolchain auto-download
          GOFLAGS: "-mod=vendor" # Force vendor globally
          GIT_TERMINAL_PROMPT: "0" # Fail fast on git prompts
        run: |
          set -euo pipefail

          # Force cold cache (per-step unique, no warm cache cheating)
          GOMODCACHE="$(mktemp -d)"
          export GOMODCACHE
          GOCACHE="$(mktemp -d)"
          export GOCACHE

          echo "üîí Hermetic Build Proof - Adversarial Conditions"
          echo "   GOPROXY=off, GOVCS=*:off, GOTOOLCHAIN=local"
          echo "   Cold cache: GOMODCACHE=$GOMODCACHE"
          echo "   Cold cache: GOCACHE=$GOCACHE"

          # Print environment for audit trail
          echo "üìã Go Environment (Hermetic Proof):"
          go env | grep -E '(GOPROXY|GOMODCACHE|GOCACHE|GOTOOLCHAIN|GOVCS|GOFLAGS)'

          # Clean Go build cache (but preserve WebUI dist/ and vendor/)
          echo "üßπ Cleaning Go build artifacts..."
          rm -rf bin/
          go clean -cache -testcache || true

          # Generate code (must use vendored tools)
          echo "üîß Generating code with vendored tools..."
          make generate

          # Verify determinism (directory-based, not specific filenames)
          echo "üîç Verifying deterministic generation..."
          if ! git diff --exit-code -- internal/api internal/control/http/v3; then
            echo "‚ùå Generated code is non-deterministic or uncommitted"
            echo "   Review changes above and commit if intentional"
            exit 1
          fi

          # Build without network (WebUI dist/ already exists from earlier step)
          echo "üèóÔ∏è  Building binary offline..."
          go build -v -mod=vendor -o /tmp/xg2g-hermetic ./cmd/daemon

          echo "‚úÖ Build succeeded under adversarial offline conditions"
          echo "   ‚Üí Truly hermetic (no network, no cache, no toolchain download)"
          echo "   ‚Üí Deterministic generation verified"

      - name: Setup Node for OpenAPI lint
        uses: actions/setup-node@v6
        with:
          node-version: "lts/*"

      - name: Lint OpenAPI
        run: |
          set -euo pipefail
          npx --yes @redocly/cli@latest lint api/openapi.yaml --format=stylish | tee /tmp/openapi-lint.txt

      - name: Attach OpenAPI lint report
        if: always()
        uses: actions/upload-artifact@4cea002c0b490497914856006bbd902ffdbccf9d1a33 # v4.0.0
        with:
          name: openapi-lint
          path: /tmp/openapi-lint.txt
          retention-days: 14

      - name: OpenAPI lint summary
        if: always()
        run: |
          echo "## OpenAPI Lint" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          tail -n 200 /tmp/openapi-lint.txt >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Create and Verify Review Artifact
        run: |
          set -euo pipefail
          make review-zip
          # make review-zip already calls verify-zip, but we can be explicit
          make verify-zip

      - name: "Integration (Smoke Test)"
        env:
          XG2G_SMOKE_DATA_DIR: ./data
        run: |
          set -euo pipefail
          # Run the Go-based smoke test which builds and validates the daemon end-to-end
          make smoke-test

      - name: Output validation
        run: |
          set -euo pipefail
          test -f ./data/playlist.m3u
          test -f ./data/xmltv.xml
          test "$(grep -c '^#EXTINF' ./data/playlist.m3u || true)" -ge 2
          test "$(grep -c '<channel ' ./data/xmltv.xml || true)" -ge 2
          ! grep -q 'FROM BOUQUET' ./data/playlist.m3u

      - name: Job summary
        if: always()
        run: |
          set -euo pipefail

          COV="n/a"
          if [ -f coverage.out ]; then
            COV=$(go tool cover -func=coverage.out | awk '/total:/ {print $3}')
          fi

          EXTINF=0
          if [ -f ./data/playlist.m3u ]; then
            EXTINF=$(grep -c '^#EXTINF' ./data/playlist.m3u || echo 0)
          fi

          CHANNELS=0
          if [ -f ./data/xmltv.xml ]; then
            CHANNELS=$(grep -c '<channel ' ./data/xmltv.xml || echo 0)
          fi

          GOLD_HASH="n/a"
          if [ -f internal/epg/testdata/xmltv.golden.xml ]; then
            GOLD_HASH=$(shasum -a 256 internal/epg/testdata/xmltv.golden.xml | awk '{print $1}')
          fi

          {
            echo "## CI Result"
            echo ""
            echo "- Coverage: ${COV}"
            echo "- Playlist entries (#EXTINF): ${EXTINF}"
            echo "- XMLTV Channels: ${CHANNELS}"
            echo "- Artifacts: logs-and-reports"
            echo "- Daemon base: http://127.0.0.1${XG2G_LISTEN:-:8080}"
            echo "- xmltv.golden.xml (sha256): ${GOLD_HASH}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Install golangci-lint (built with runner Go)
        run: |
          set -euo pipefail
          # Build golangci-lint from source using the runner's Go toolchain
          # to avoid version mismatch errors with prebuilt binaries.
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.8.0
          golangci-lint --version

      - name: Lint
        run: |
          set -euo pipefail
          golangci-lint run --timeout=5m --verbose ./...

      - name: Lint Markdown
        continue-on-error: true # Don't block CI on markdown linting issues
        run: |
          set -euo pipefail
          npx --yes markdownlint-cli2 "docs/**/*.md" ".github/**/*.md" "*.md"

      - name: Go test (repeat)
        run: |
          set -euo pipefail
          # Pure Go tests with race detection
          go test -race "$(go list ./... | grep -v '/test$')" -v

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@4cea002c0b490497914856006bbd902ffdbccf9d1a33 # v4.0.0
        with:
          name: logs-and-reports
          path: |
            coverage.out
            /tmp/daemon.log
            ./data/*
          if-no-files-found: ignore
          retention-days: 14

  # Optional: Full EPG smoke test against a real receiver (requires secrets)
  # full-epg-smoke:
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 30
  #   if: ${{ github.event_name == 'workflow_dispatch' }}
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v6
  #     - name: Setup Go
  #       uses: actions/setup-go@v6 # v5
  #       with:
  #         go-version-file: go.mod
  #         cache: true
  #     - name: Run full EPG smoke test
  #       env:
  #         XG2G_OWI_BASE: ${{ secrets.XG2G_OWI_BASE }}
  #         XG2G_BOUQUET: Premium
  #         XG2G_XMLTV: xmltv.xml
  #         XG2G_EPG_ENABLED: "true"
  #         XG2G_EPG_DAYS: "7"
  #         XG2G_EPG_MAX_CONCURRENCY: "6"
  #         XG2G_EPG_TIMEOUT_MS: "20000"
  #         XG2G_API_TOKEN: ${{ secrets.XG2G_API_TOKEN }}
  #         EPG_MIN_BYTES: $((5 * 1024 * 1024))
  #         EPG_MIN_PROGRAMMES: "5000"
  #       run: |
  #         set -euo pipefail
  #         ./scripts/epg-full-refresh.sh

  validate-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@3041dee5d64473ef0bad009d902ffdbccf9d1a33 # v6
        with:
          go-version-file: go.mod

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v5.3.0
        with:
          python-version: "3.x"

      - name: Install check-jsonschema
        run: |
          python -m venv .venv
          . .venv/bin/activate
          pip install check-jsonschema==0.31.0

      - name: Validate configs against JSON Schema
        run: |
          set -euo pipefail
          . .venv/bin/activate
          check-jsonschema --schemafile docs/guides/config.schema.json config.example.yaml
          check-jsonschema --schemafile docs/guides/config.schema.json config.generated.example.yaml
          find internal/config/testdata -name 'valid*.yaml' -maxdepth 1 -type f -print0 | xargs -0 -I{} check-jsonschema --schemafile docs/guides/config.schema.json {}
          if [ -d examples ]; then find examples -name '*.ya?ml' -type f -print0 | xargs -0 -I{} check-jsonschema --schemafile docs/guides/config.schema.json {}; fi

      - name: Build validate tool
        run: go build -o validate ./cmd/validate

      - name: Validate generated config example
        run: ./validate -f config.generated.example.yaml

      - name: Validate example configs with tool
        run: |
          set -euo pipefail
          if [ -f config.yaml ]; then ./validate -f config.yaml; fi
          find internal/config/testdata -name 'valid*.yaml' -maxdepth 1 -type f -print0 | xargs -0 -I{} ./validate -f {}
          if [ -d examples ]; then find examples -name '*.ya?ml' -type f -print0 | xargs -0 -I{} ./validate -f {}; fi

  contract-matrix:
    name: Contract Matrix (P4-1)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@3041dee5d64473ef0bad009d902ffdbccf9d1a33 # v6
        with:
          go-version-file: go.mod
          check-latest: true
          cache: true

      - name: Run Contract Matrix
        run: make contract-matrix

      - name: Fail if golden snapshots changed
        run: |
          set -euo pipefail
          if [[ -n "$(git status --porcelain testdata/contract/p4_1)" ]]; then
            echo "‚ùå Golden snapshots or contract cases have uncommitted changes"
            echo "   This indicates contract drift or accidental golden regeneration"
            git status testdata/contract/p4_1
            git diff testdata/contract/p4_1
            exit 1
          fi
          echo "‚úÖ Contract matrix verified (no drift)"
