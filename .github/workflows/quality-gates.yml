name: Complexity & Quality Gates

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  complexity-check:
    name: Check Cyclomatic Complexity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Install gocyclo
        run: go install github.com/fzipp/gocyclo/cmd/gocyclo@latest

      - name: Check Complexity Threshold
        run: |
          echo "ğŸ” Checking for functions with cyclomatic complexity >20..."
          if gocyclo -over 20 ./internal ./cmd; then
            echo "âœ… All functions below complexity threshold"
          else
            echo "âŒ High complexity detected (>20)"
            echo "ğŸ’¡ Refactor complex functions or update threshold"
            exit 1
          fi

  openapi-drift-check:
    name: Prevent OpenAPI Drift
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Check OpenAPI Sync
        run: |
          echo "ğŸ” Checking OpenAPI specification sync..."

          # Check if openapi.yaml changed
          if git diff --name-only origin/main...HEAD | grep -q "openapi.yaml"; then
            echo "âš ï¸  openapi.yaml changed - verifying sync..."
            
            # Regenerate if Makefile target exists
            if grep -q "generate-api" Makefile 2>/dev/null; then
              make generate-api || echo "Warning: generate-api target not found"
              
              # Check for drift
              if git diff --exit-code internal/api/v3/server_gen.go; then
                echo "âœ… OpenAPI and generated code in sync"
              else
                echo "âŒ OpenAPI drift detected"
                echo "Generated code doesnt match openapi.yaml"
                echo "ğŸ’¡ Run: make generate-api && git add internal/api/v3/server_gen.go"
                exit 1
              fi
            else
              echo "âš ï¸  Skipping: generate-api target not found in Makefile"
            fi
          else
            echo "âœ… openapi.yaml unchanged - no drift check needed"
          fi

  lint-and-test:
    name: Lint & Test (Hard Gates)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --timeout=5m

      - name: Run Tests
        run: go test ./... -v -race -coverprofile=coverage.out

      - name: Go Vet
        run: go vet ./...
