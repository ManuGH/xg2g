name: docker-multi-cpu

on:
  push:
    branches: [main]
    tags:
      - 'v*'
    paths:
      - Dockerfile
      - "**/*.go"
      - "**/*.rs"
      - go.mod
      - go.sum
      - .github/workflows/docker-multi-cpu.yml
  schedule:
    - cron: '17 2 * * *'  # Daily at 02:17 UTC - ARM64 canary test
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  # =============================================================================
  # AMD64 Builds with CPU-Level Optimization
  # =============================================================================
  build-amd64:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cpu_level:
          - name: v1
            rust_features: ""
            suffix: v1-compat
            description: "Legacy compatibility (CPUs ≥2003)"
          - name: v2
            rust_features: "-C target-feature=+sse3,+ssse3,+sse4.1,+sse4.2,+popcnt"
            suffix: ""
            description: "Standard (CPUs ≥2009, default)"
          - name: v3
            rust_features: "-C target-feature=+sse3,+ssse3,+sse4.1,+sse4.2,+popcnt,+avx,+avx2,+bmi1,+bmi2,+fma"
            suffix: v3-performance
            description: "High performance (CPUs ≥2015, AVX2)"
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Verify modules
        run: |
          go mod tidy
          go mod verify
          git diff --exit-code -- go.mod go.sum

      - uses: docker/setup-qemu-action@v3

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate tags
        id: meta
        run: |
          TAGS=""
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          # Version tags (on v* releases)
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"

            # Standard build (v2) gets :latest and :v1.2.3
            if [ "${{ matrix.cpu_level.name }}" = "v2" ]; then
              TAGS="ghcr.io/${REPO_OWNER}/xg2g:latest"
              TAGS="${TAGS},ghcr.io/${REPO_OWNER}/xg2g:${VERSION}"
            fi

            # All builds get versioned CPU-specific tags
            if [ -n "${{ matrix.cpu_level.suffix }}" ]; then
              TAGS="${TAGS},ghcr.io/${REPO_OWNER}/xg2g:${VERSION}-${{ matrix.cpu_level.suffix }}"
              TAGS="${TAGS},ghcr.io/${REPO_OWNER}/xg2g:${{ matrix.cpu_level.suffix }}"
            fi
          fi

          # Main branch tags
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            # Standard build (v2) gets :main
            if [ "${{ matrix.cpu_level.name }}" = "v2" ]; then
              TAGS="${TAGS},ghcr.io/${REPO_OWNER}/xg2g:main"
            fi

            # CPU-specific main tags
            if [ -n "${{ matrix.cpu_level.suffix }}" ]; then
              TAGS="${TAGS},ghcr.io/${REPO_OWNER}/xg2g:main-${{ matrix.cpu_level.suffix }}"
            fi
          fi

          # SHA tags for all builds
          TAGS="${TAGS},ghcr.io/${REPO_OWNER}/xg2g:sha-${GITHUB_SHA::7}-amd64-${{ matrix.cpu_level.name }}"

          # Remove leading comma if present
          TAGS="${TAGS#,}"

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "### AMD64 ${{ matrix.cpu_level.name }} Tags" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${TAGS}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Build and push AMD64 ${{ matrix.cpu_level.name }}
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64
          push: ${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/') }}
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            GO_AMD64_LEVEL=${{ matrix.cpu_level.name }}
            RUST_TARGET_FEATURES=${{ matrix.cpu_level.rust_features }}
            GIT_REF=${{ github.sha }}
          labels: |
            org.opencontainers.image.title=xg2g
            org.opencontainers.image.description=xg2g - AMD64 ${{ matrix.cpu_level.description }}
            org.opencontainers.image.vendor=ManuGH
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.cpu-level=${{ matrix.cpu_level.name }}
          cache-from: type=gha,scope=amd64-${{ matrix.cpu_level.name }}
          cache-to: type=gha,mode=max,scope=amd64-${{ matrix.cpu_level.name }}
          provenance: true
          sbom: true

      - name: Output digest
        if: always()
        run: |
          echo "AMD64 ${{ matrix.cpu_level.name }} digest: ${{ steps.build.outputs.digest }}" | tee -a "$GITHUB_STEP_SUMMARY"

  # =============================================================================
  # ARM64 Build (no CPU-level variants)
  # =============================================================================
  # ⚠️ ARM64 builds via QEMU are VERY slow (60-90 min vs 15-20 min native)
  # Strategy: Only build ARM64 on releases to keep main-branch CI fast
  # TODO: Implement cross-compilation (Option 2) for faster ARM64 builds
  build-arm64:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Verify modules
        run: |
          go mod tidy
          go mod verify
          git diff --exit-code -- go.mod go.sum

      - uses: docker/setup-qemu-action@v3

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate tags
        id: meta
        run: |
          TAGS=""
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          # Version tags (on v* releases)
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            TAGS="ghcr.io/${REPO_OWNER}/xg2g:${VERSION}-arm64"
          fi

          # Main branch tags
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            TAGS="${TAGS},ghcr.io/${REPO_OWNER}/xg2g:main-arm64"
          fi

          # SHA tags
          TAGS="${TAGS},ghcr.io/${REPO_OWNER}/xg2g:sha-${GITHUB_SHA::7}-arm64"

          # Remove leading comma if present
          TAGS="${TAGS#,}"

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "### ARM64 Tags" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${TAGS}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Build and push ARM64
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: linux/arm64
          push: ${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/') }}
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            GIT_REF=${{ github.sha }}
          labels: |
            org.opencontainers.image.title=xg2g
            org.opencontainers.image.description=xg2g - ARM64
            org.opencontainers.image.vendor=ManuGH
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha,scope=arm64
          cache-to: type=gha,mode=max,scope=arm64
          provenance: true
          sbom: true

      - name: Output digest
        if: always()
        run: |
          echo "ARM64 digest: ${{ steps.build.outputs.digest }}" | tee -a "$GITHUB_STEP_SUMMARY"

  # =============================================================================
  # ARM64 Canary (Nightly Cross-Compile Test - No Push)
  # =============================================================================
  # Daily ARM64 cross-compile test to catch breakages early without blocking main
  # Runs at 02:17 UTC, builds ARM64 binaries natively (no QEMU), uploads artifacts
  arm64-canary:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      # Install Rust with ARM64 target
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      # Install cargo-zigbuild for cross-compilation
      - name: Install cargo-zigbuild
        run: |
          cargo install cargo-zigbuild --locked
          echo "$(cargo install --list | grep cargo-zigbuild)" >> "$GITHUB_STEP_SUMMARY"

      # Build Rust library for ARM64 (no QEMU needed)
      - name: Cross-compile Rust library for ARM64
        run: |
          cd transcoder
          cargo zigbuild --release --target aarch64-unknown-linux-gnu
          file target/aarch64-unknown-linux-gnu/release/libxg2g_transcoder.so
          ls -lh target/aarch64-unknown-linux-gnu/release/libxg2g_transcoder.so
          echo "### Rust ARM64 Binary" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          file target/aarch64-unknown-linux-gnu/release/libxg2g_transcoder.so >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      # Build Go binary for ARM64 (CGO disabled for static build)
      - name: Cross-compile Go binary for ARM64
        run: |
          mkdir -p dist
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 \
            go build -trimpath -ldflags="-s -w -X main.Version=canary-$(date +%Y%m%d)" \
            -o dist/xg2g-arm64 ./cmd/daemon
          file dist/xg2g-arm64
          ls -lh dist/xg2g-arm64
          echo "### Go ARM64 Binary" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          file dist/xg2g-arm64 >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      # Verify binaries are statically linked (preferred for portability)
      - name: Verify static linking
        run: |
          echo "### Link Analysis" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "Rust library:" >> "$GITHUB_STEP_SUMMARY"
          ldd transcoder/target/aarch64-unknown-linux-gnu/release/libxg2g_transcoder.so || echo "Static (no dynamic deps)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Go binary:" >> "$GITHUB_STEP_SUMMARY"
          file dist/xg2g-arm64 | grep -q "statically linked" && echo "✅ Static" >> "$GITHUB_STEP_SUMMARY" || echo "⚠️ Dynamic" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      # Upload ARM64 binaries as artifacts (no Docker push)
      - name: Upload ARM64 canary binaries
        uses: actions/upload-artifact@v5
        with:
          name: canary-arm64-binaries-${{ github.run_number }}
          path: |
            transcoder/target/aarch64-unknown-linux-gnu/release/libxg2g_transcoder.so
            dist/xg2g-arm64
          retention-days: 7

      - name: Summary
        run: |
          echo "✅ ARM64 canary build completed successfully" >> "$GITHUB_STEP_SUMMARY"
          echo "**Purpose**: Validate ARM64 cross-compile without blocking main branch" >> "$GITHUB_STEP_SUMMARY"
          echo "**Next step**: Enable cross-compile for releases when ARM64 usage increases" >> "$GITHUB_STEP_SUMMARY"

  # =============================================================================
  # ARM64 Cross-Compilation (OPTION 2 - PREPARED, DISABLED)
  # =============================================================================
  # TODO: Enable this for fast ARM64 builds (5-10 min vs 60-90 min QEMU)
  # Uncomment when ready to test cross-compilation
  #
  # build-arm64-cross:
  #   if: startsWith(github.ref, 'refs/tags/v')
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v5
  #
  #     - uses: dtolnay/rust-toolchain@stable
  #       with:
  #         targets: aarch64-unknown-linux-musl
  #
  #     - name: Install cross-compilation tools
  #       run: |
  #         cargo install cargo-zigbuild
  #         sudo apt-get update
  #         sudo apt-get install -y gcc-aarch64-linux-gnu
  #
  #     - name: Build Rust library for ARM64
  #       run: |
  #         cd transcoder
  #         cargo zigbuild --release --target aarch64-unknown-linux-musl
  #
  #     - name: Build Go binary for ARM64
  #       run: |
  #         GOOS=linux GOARCH=arm64 CGO_ENABLED=0 \
  #           go build -trimpath -ldflags="-s -w" -o xg2g-arm64 ./cmd/daemon
  #
  #     - name: Build Docker image
  #       uses: docker/build-push-action@v6
  #       with:
  #         context: .
  #         file: Dockerfile.cross-arm64
  #         platforms: linux/arm64
  #         push: true
  #         tags: ghcr.io/manugh/xg2g:main-arm64-cross

  # =============================================================================
  # Create Multi-Arch Manifests
  # =============================================================================
  # For main: AMD64-only (ARM64 skipped for speed)
  # For releases: AMD64 + ARM64 multi-arch
  create-manifests:
    runs-on: ubuntu-latest
    needs: [build-amd64]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create multi-arch manifests
        run: |
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          # For :latest (v2 amd64 + arm64) - ONLY ON RELEASES
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"

            # Create :latest manifest (amd64-v2 + arm64)
            docker buildx imagetools create -t ghcr.io/${REPO_OWNER}/xg2g:latest \
              ghcr.io/${REPO_OWNER}/xg2g:${VERSION} \
              ghcr.io/${REPO_OWNER}/xg2g:${VERSION}-arm64

            echo "✅ Created multi-arch manifest: ghcr.io/${REPO_OWNER}/xg2g:latest (AMD64-v2 + ARM64)" | tee -a "$GITHUB_STEP_SUMMARY"
          fi

          # For :main (AMD64-v2 ONLY on main branch, ARM64 skipped for speed)
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "ℹ️  :main tag points to AMD64-v2 only (ARM64 builds only on releases)" | tee -a "$GITHUB_STEP_SUMMARY"
            echo "✅ Image available: ghcr.io/${REPO_OWNER}/xg2g:main (AMD64-v2)" | tee -a "$GITHUB_STEP_SUMMARY"
          fi
