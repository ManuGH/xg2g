openapi: 3.0.3
info:
  title: xg2g API
  description: API for xg2g (Enigma2 to Plex/Jellyfin Proxy)
  version: 2.0.0
servers:
  - url: /api/v2
    description: Production API

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Error:
      type: object
      properties:
        type:
          type: string
          format: uri
          example: "about:blank"
        title:
          type: string
          example: "Internal Server Error"
        status:
          type: integer
          example: 500
        detail:
          type: string
          example: "Failed to connect to database"

    SystemHealth:
      type: object
      properties:
        status:
          type: string
          enum: [ok, degraded, error]
        receiver:
          $ref: "#/components/schemas/ComponentStatus"
        epg:
          $ref: "#/components/schemas/EPGStatus"
        version:
          type: string
        uptime_seconds:
          type: integer
          format: int64

    ComponentStatus:
      type: object
      properties:
        status:
          type: string
          enum: [ok, error]
        last_check:
          type: string
          format: date-time

    EPGStatus:
      type: object
      properties:
        status:
          type: string
          enum: [ok, missing]
        missing_channels:
          type: integer

    OpenWebIFConfig:
      type: object
      properties:
        baseUrl:
          type: string
        username:
          type: string
        password:
          type: string
        streamPort:
          type: integer

    EPGConfig:
      type: object
      properties:
        enabled:
          type: boolean
        days:
          type: integer
        source:
          type: string
          enum: [bouquet, per-service]

    PiconsConfig:
      type: object
      properties:
        baseUrl:
          type: string

    FeatureFlags:
      type: object
      properties:
        instantTune:
          type: boolean

    ConfigUpdate:
      type: object
      properties:
        openWebIF:
          $ref: "#/components/schemas/OpenWebIFConfig"
        bouquets:
          type: array
          items:
            type: string
        epg:
          $ref: "#/components/schemas/EPGConfig"
        picons:
          $ref: "#/components/schemas/PiconsConfig"
        featureFlags:
          $ref: "#/components/schemas/FeatureFlags"

    AppConfig:
      type: object
      properties:
        version:
          type: string
        dataDir:
          type: string
        logLevel:
          type: string
        openWebIF:
          $ref: "#/components/schemas/OpenWebIFConfig"
        bouquets:
          type: array
          items:
            type: string
        epg:
          $ref: "#/components/schemas/EPGConfig"
        picons:
          $ref: "#/components/schemas/PiconsConfig"
        featureFlags:
          $ref: "#/components/schemas/FeatureFlags"

    Bouquet:
      type: object
      properties:
        name:
          type: string
        services:
          type: integer

    Service:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        group:
          type: string
        logo_url:
          type: string
        number:
          type: string
        enabled:
          type: boolean
        service_ref:
          type: string
          description: Service reference for streaming (extracted from M3U URL)

    LogEntry:
      type: object
      properties:
        time:
          type: string
          format: date-time
        level:
          type: string
        message:
          type: string
        fields:
          type: object
          additionalProperties: true

    StreamSession:
      type: object
      properties:
        id:
          type: string
        client_ip:
          type: string
        channel_name:
          type: string
        started_at:
          type: string
          format: date-time
        state:
          type: string
          enum: [active, idle]

security:
  - BearerAuth: []

paths:
  /system/health:
    get:
      summary: Get system health
      responses:
        "200":
          description: Health status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SystemHealth"

  /system/config:
    get:
      summary: Get system configuration
      responses:
        "200":
          description: Configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AppConfig"
    put:
      summary: Update system configuration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConfigUpdate"
      responses:
        "200":
          description: Configuration updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  restart_required:
                    type: boolean
        "400":
          description: Invalid configuration
        "500":
          description: Failed to save configuration

  /system/refresh:
    post:
      summary: Trigger data refresh (EPG/Channels)
      responses:
        "202":
          description: Refresh started
        "409":
          description: Refresh already in progress

  /services/bouquets:
    get:
      summary: List all bouquets
      operationId: getServicesBouquets
      tags:
        - services
      responses:
        "200":
          description: List of bouquets
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Bouquet"

  /epg:
    get:
      summary: Get EPG data
      operationId: getEpg
      tags:
        - epg
      parameters:
        - name: from
          in: query
          schema:
            type: integer
          description: Start timestamp (unix seconds)
        - name: to
          in: query
          schema:
            type: integer
          description: End timestamp (unix seconds)
        - name: bouquet
          in: query
          schema:
            type: string
          description: Filter by bouquet name
        - name: q
          in: query
          schema:
            type: string
          description: Filter by search query
      responses:
        "200":
          description: EPG data
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        service_ref:
                          type: string
                        title:
                          type: string
                        desc:
                          type: string
                        start:
                          type: integer
                        end:
                          type: integer

  /services:
    get:
      summary: List all services (channels)
      parameters:
        - in: query
          name: bouquet
          schema:
            type: string
          description: Filter by bouquet name
      responses:
        "200":
          description: List of services
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Service"

  /services/{id}/toggle:
    post:
      summary: Toggle service enabled state
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                enabled:
                  type: boolean
      responses:
        "200":
          description: Status updated
        "404":
          description: Service not found

  /streams:
    get:
      summary: List active streams
      responses:
        "200":
          description: Active sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/StreamSession"

  /streams/{id}:
    delete:
      summary: Terminate a stream session
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Session terminated
        "404":
          description: Session not found

  /logs:
    get:
      summary: Get recent logs
      responses:
        "200":
          description: Recent log entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/LogEntry"
