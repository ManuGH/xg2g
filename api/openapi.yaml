openapi: 3.0.3
info:
  title: xg2g API
  description: |
    API for xg2g (Enigma2 to Plex/Jellyfin Proxy).

    **License**: PolyForm Noncommercial License 1.0.0.
    Commercial usage is restricted. See repository documentation for details.
  version: 2.0.0
servers:
  - url: /api/v2
    description: Production API

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Error:
      type: object
      properties:
        type:
          type: string
          format: uri
          example: "about:blank"
        title:
          type: string
          example: "Internal Server Error"
        status:
          type: integer
          example: 500
        detail:
          type: string
          example: "Failed to connect to database"

    SystemHealth:
      type: object
      properties:
        status:
          type: string
          enum: [ok, degraded, error]
        receiver:
          $ref: "#/components/schemas/ComponentStatus"
        epg:
          $ref: "#/components/schemas/EPGStatus"
        version:
          type: string
        uptime_seconds:
          type: integer
          format: int64

    ComponentStatus:
      type: object
      properties:
        status:
          type: string
          enum: [ok, error]
        last_check:
          type: string
          format: date-time

    EPGStatus:
      type: object
      properties:
        status:
          type: string
          enum: [ok, missing]
        missing_channels:
          type: integer

    OpenWebIFConfig:
      type: object
      properties:
        baseUrl:
          type: string
        username:
          type: string
        password:
          type: string
        streamPort:
          type: integer

    EPGConfig:
      type: object
      properties:
        enabled:
          type: boolean
        days:
          type: integer
        source:
          type: string
          enum: [bouquet, per-service]

    PiconsConfig:
      type: object
      properties:
        baseUrl:
          type: string

    FeatureFlags:
      type: object
      properties:
        instantTune:
          type: boolean

    SeriesRuleRunReport:
      type: object
      properties:
        ruleId: { type: string }
        runId: { type: string }
        trigger: { type: string }
        startedAt: { type: string, format: date-time }
        finishedAt: { type: string, format: date-time }
        durationMs: { type: integer, format: int64 }
        windowFrom: { type: integer, format: int64 }
        windowTo: { type: integer, format: int64 }
        status: { type: string, enum: [success, partial, failed] }
        summary: { $ref: "#/components/schemas/RunSummary" }
        snapshot: { $ref: "#/components/schemas/RuleSnapshot" }
        decisions:
          type: array
          items: { $ref: "#/components/schemas/RunDecision" }
        errors:
          type: array
          items: { $ref: "#/components/schemas/RunError" }
        conflicts:
          type: array
          items: { $ref: "#/components/schemas/RunConflict" }

    RunSummary:
      type: object
      properties:
        epgItemsScanned: { type: integer }
        epgItemsMatched: { type: integer }
        timersAttempted: { type: integer }
        timersCreated: { type: integer }
        timersSkipped: { type: integer }
        timersConflicted: { type: integer }
        timersErrored: { type: integer }
        maxTimersGlobalPerRunHit: { type: boolean }
        maxMatchesScannedPerRuleHit: { type: boolean }
        receiverUnreachable: { type: boolean }

    RunDecision:
      type: object
      properties:
        serviceRef: { type: string }
        begin: { type: integer, format: int64 }
        end: { type: integer, format: int64 }
        title: { type: string }
        action: { type: string }
        reason: { type: string }
        matchReason:
          type: array
          items: { type: string }
        timerId: { type: string }
        details: { type: string }

    RunError:
      type: object
      properties:
        type: { type: string }
        message: { type: string }
        at: { type: string, format: date-time }
        retryable: { type: boolean }

    RunConflict:
      type: object
      properties:
        serviceRef: { type: string }
        begin: { type: integer, format: int64 }
        end: { type: integer, format: int64 }
        title: { type: string }
        blockingTimerId: { type: string }
        overlapSeconds: { type: integer, format: int64 }
        message: { type: string }

    RuleSnapshot:
      type: object
      properties:
        id: { type: string }
        enabled: { type: boolean }
        keyword: { type: string }
        channelRef: { type: string }
        days:
          type: array
          items: { type: integer }
        startWindow: { type: string }
        priority: { type: integer }
    SeriesRule:
      type: object
      properties:
        id:
          type: string
          readOnly: true
        enabled:
          type: boolean
          default: true
        keyword:
          type: string
          description: Search term or regex for event title
        channel_ref:
          type: string
          description: Optional service reference to restrict rule
        days:
          type: array
          items:
            type: integer
            minimum: 0
            maximum: 6
          description: Days of week (0=Sunday)
        start_window:
          type: string
          description: Time window HHMM-HHMM
        priority:
          type: integer
          default: 0
        lastRunAt:
          type: string
          format: date-time
        lastRunStatus:
          type: string
        lastRunSummary:
          $ref: "#/components/schemas/RunSummary"

    ConfigUpdate:
      type: object
      properties:
        openWebIF:
          $ref: "#/components/schemas/OpenWebIFConfig"
        bouquets:
          type: array
          items:
            type: string
        epg:
          $ref: "#/components/schemas/EPGConfig"
        picons:
          $ref: "#/components/schemas/PiconsConfig"
        featureFlags:
          $ref: "#/components/schemas/FeatureFlags"

    AppConfig:
      type: object
      properties:
        version:
          type: string
        dataDir:
          type: string
        logLevel:
          type: string
        openWebIF:
          $ref: "#/components/schemas/OpenWebIFConfig"
        bouquets:
          type: array
          items:
            type: string
        epg:
          $ref: "#/components/schemas/EPGConfig"
        picons:
          $ref: "#/components/schemas/PiconsConfig"
        featureFlags:
          $ref: "#/components/schemas/FeatureFlags"

    Bouquet:
      type: object
      properties:
        name:
          type: string
        services:
          type: integer

    Service:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        group:
          type: string
        logo_url:
          type: string
        number:
          type: string
        enabled:
          type: boolean
        service_ref:
          type: string
          description: Service reference for streaming (extracted from M3U URL)

    ProblemDetails:
      type: object
      required: [type, title, status]
      properties:
        type: { type: string }
        title: { type: string }
        status: { type: integer }
        detail: { type: string }
        instance: { type: string }
        fields:
          type: object
          additionalProperties: true
        conflicts:
          type: array
          items: { $ref: "#/components/schemas/TimerConflict" }

    Timer:
      type: object
      required: [timerId, serviceRef, begin, end, name, state]
      properties:
        timerId: { type: string }
        serviceRef: { type: string }
        begin: { type: integer, format: int64 }
        end: { type: integer, format: int64 }
        name: { type: string }
        description: { type: string }
        serviceName: { type: string }
        state:
          type: string
          enum: [scheduled, recording, completed, disabled, unknown]
        receiverState:
          type: object
          additionalProperties: true
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    TimerCreateRequest:
      type: object
      required: [serviceRef, begin, end, name]
      properties:
        serviceRef: { type: string }
        begin: { type: integer, format: int64 }
        end: { type: integer, format: int64 }
        name: { type: string }
        description: { type: string }
        enabled: { type: boolean, default: true }
        justPlay: { type: boolean, default: false }
        afterEvent:
          type: string
          enum: [default, standby, deepstandby, nothing]
          default: default
        paddingBeforeSec: { type: integer, default: 0 }
        paddingAfterSec: { type: integer, default: 0 }
        idempotencyKey: { type: string }

    TimerPatchRequest:
      type: object
      properties:
        begin: { type: integer, format: int64 }
        end: { type: integer, format: int64 }
        name: { type: string }
        description: { type: string }
        enabled: { type: boolean }
        paddingBeforeSec: { type: integer }
        paddingAfterSec: { type: integer }

    TimerConflict:
      type: object
      required: [type, blockingTimer]
      properties:
        type:
          type: string
          enum: [overlap, duplicate, tuner_limit, unknown]
        blockingTimer: { $ref: "#/components/schemas/Timer" }
        overlapSeconds: { type: integer }
        message: { type: string }

    TimerConflictPreviewRequest:
      type: object
      required: [proposed]
      properties:
        proposed:
          $ref: "#/components/schemas/TimerCreateRequest"
        mode:
          type: string
          enum: [conservative, receiverAware]
          default: conservative

    TimerConflictPreviewResponse:
      type: object
      required: [canSchedule, conflicts]
      properties:
        canSchedule: { type: boolean }
        conflicts:
          type: array
          items: { $ref: "#/components/schemas/TimerConflict" }
        suggestions:
          type: array
          items:
            type: object
            properties:
              kind:
                { type: string, enum: [reduce_padding, shift_start, shift_end] }
              proposedBegin: { type: integer, format: int64 }
              proposedEnd: { type: integer, format: int64 }
              note: { type: string }

    DvrCapabilities:
      type: object
      required: [timers, conflicts, series]
      properties:
        timers:
          type: object
          properties:
            edit: { type: boolean }
            delete: { type: boolean }
            readBackVerify: { type: boolean }
        conflicts:
          type: object
          properties:
            preview: { type: boolean }
            receiverAware: { type: boolean }
        series:
          type: object
          properties:
            supported: { type: boolean }
            mode: { type: string, enum: [none, delegated, managed] }
            delegatedProvider: { type: string }

    RecordingStatus:
      type: object
      required: [isRecording]
      properties:
        isRecording: { type: boolean }
        serviceName: { type: string }

    TimerList:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/Timer" }

    LogEntry:
      type: object
      properties:
        time:
          type: string
          format: date-time
        level:
          type: string
        message:
          type: string
        fields:
          type: object
          additionalProperties: true

    StreamSession:
      type: object
      properties:
        id:
          type: string
        client_ip:
          type: string
        channel_name:
          type: string
        started_at:
          type: string
          format: date-time
        state:
          type: string
          enum: [active, idle]

    RecordingRoot:
      type: object
      properties:
        id: { type: string }
        name: { type: string }

    Breadcrumb:
      type: object
      properties:
        name: { type: string }
        path: { type: string }

    DirectoryItem:
      type: object
      properties:
        name: { type: string }
        path: { type: string }

    RecordingItem:
      type: object
      properties:
        service_ref: { type: string }
        title: { type: string }
        description: { type: string }
        begin: { type: integer, format: int64 }
        length: { type: string }
        filename: { type: string }

    RecordingResponse:
      type: object
      properties:
        roots:
          type: array
          items: { $ref: "#/components/schemas/RecordingRoot" }
        current_root: { type: string }
        current_path: { type: string }
        breadcrumbs:
          type: array
          items: { $ref: "#/components/schemas/Breadcrumb" }
        directories:
          type: array
          items: { $ref: "#/components/schemas/DirectoryItem" }
        recordings:
          type: array
          items: { $ref: "#/components/schemas/RecordingItem" }

security:
  - BearerAuth: []

paths:
  /system/health:
    get:
      summary: Get system health
      responses:
        "200":
          description: Health status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SystemHealth"

  /system/config:
    get:
      summary: Get system configuration
      responses:
        "200":
          description: Configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AppConfig"
    put:
      summary: Update system configuration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConfigUpdate"
      responses:
        "200":
          description: Configuration updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  restart_required:
                    type: boolean
        "400":
          description: Invalid configuration
        "500":
          description: Failed to save configuration

  /system/refresh:
    post:
      summary: Trigger data refresh (EPG/Channels)
      responses:
        "202":
          description: Refresh started
        "409":
          description: Refresh already in progress

  /services/bouquets:
    get:
      summary: List all bouquets
      operationId: getServicesBouquets
      tags:
        - services
      responses:
        "200":
          description: List of bouquets
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Bouquet"

  /epg:
    get:
      summary: Get EPG data
      operationId: getEpg
      tags:
        - epg
      parameters:
        - name: from
          in: query
          schema:
            type: integer
          description: Start timestamp (unix seconds)
        - name: to
          in: query
          schema:
            type: integer
          description: End timestamp (unix seconds)
        - name: bouquet
          in: query
          schema:
            type: string
          description: Filter by bouquet name
        - name: q
          in: query
          schema:
            type: string
          description: Filter by search query
      responses:
        "200":
          description: EPG data
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        service_ref:
                          type: string
                        title:
                          type: string
                        desc:
                          type: string
                        start:
                          type: integer
                        end:
                          type: integer

  /services:
    get:
      summary: List all services (channels)
      parameters:
        - in: query
          name: bouquet
          schema:
            type: string
          description: Filter by bouquet name
      responses:
        "200":
          description: List of services
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Service"

  /services/{id}/toggle:
    post:
      summary: Toggle service enabled state
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                enabled:
                  type: boolean
      responses:
        "200":
          description: Status updated
        "404":
          description: Service not found

  /streams:
    get:
      summary: List active streams
      responses:
        "200":
          description: Active sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/StreamSession"

  /recordings:
    get:
      summary: Browse recordings
      operationId: getRecordings
      tags:
        - recordings
      parameters:
        - name: root
          in: query
          schema:
            type: string
          description: Root location ID
        - name: path
          in: query
          schema:
            type: string
          description: Relative path
      responses:
        "200":
          description: Recordings list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RecordingResponse"

  /recordings/{recordingId}/playlist.m3u8:
    get:
      summary: Get HLS playlist for a recording
      operationId: getRecordingHLSPlaylist
      tags:
        - recordings
      parameters:
        - name: recordingId
          in: path
          required: true
          schema:
            type: string
          description: URL-encoded service reference or ID of the recording
      responses:
        "200":
          description: HLS Playlist
          content:
            application/vnd.apple.mpegurl:
              schema:
                type: string
                format: binary
        "404":
          description: Recording not found

  /recordings/{recordingId}/{segment}:
    get:
      summary: Get HLS segment for a recording
      operationId: getRecordingHLSCustomSegment
      tags:
        - recordings
      parameters:
        - name: recordingId
          in: path
          required: true
          schema:
            type: string
        - name: segment
          in: path
          required: true
          schema:
            type: string
            pattern: '.*\.(ts|mp4|m4s|cmfv)$'
      responses:
        "200":
          description: Media Segment
          content:
            video/mp2t:
              schema:
                type: string
                format: binary

  /auth/session:
    post:
      summary: Create session cookie
      description: Exchanges the Bearer token for a secure HttpOnly session cookie, enabling native playback (HLS) without token in URL.
      operationId: createSession
      tags:
        - auth
      responses:
        "204":
          description: Session created
        "401":
          description: Unauthorized

  /timers:
    get:
      summary: List all timers (v2)
      operationId: getTimers
      tags:
        - timers
      parameters:
        - name: state
          in: query
          schema:
            type: string
            default: scheduled
        - name: from
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: List of timers
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TimerList"
    post:
      summary: Create a timer (v2)
      operationId: addTimer
      tags:
        - timers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TimerCreateRequest"
      responses:
        "201":
          description: Timer created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Timer"
        "409":
          description: Duplicate timer
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"
        "422":
          description: Conflict or validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"
        "502":
          description: Receiver inconsistent (verification failed)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"

  /timers/{timerId}:
    get:
      summary: Get timer
      operationId: getTimer
      tags:
        - timers
      parameters:
        - name: timerId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Timer details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Timer"
        "404":
          description: Timer not found
    patch:
      summary: Edit timer
      operationId: updateTimer
      tags:
        - timers
      parameters:
        - name: timerId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TimerPatchRequest"
      responses:
        "200":
          description: Timer updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Timer"
        "404":
          description: Timer not found
        "409":
          description: Duplicate resulting from edit
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"
        "422":
          description: Conflict
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemDetails"
        "502":
          description: Receiver fail / Rollback
    delete:
      summary: Delete timer
      operationId: deleteTimer
      tags:
        - timers
      parameters:
        - name: timerId
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Deleted
        "404":
          description: Not found

  /timers/conflicts:preview:
    post:
      summary: Preview conflicts
      operationId: previewConflicts
      tags:
        - timers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TimerConflictPreviewRequest"
      responses:
        "200":
          description: Preview result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TimerConflictPreviewResponse"

  /dvr/capabilities:
    get:
      summary: Get DVR capabilities
      operationId: getDvrCapabilities
      tags:
        - dvr
      responses:
        "200":
          description: Capabilities
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DvrCapabilities"

  /dvr/status:
    get:
      summary: Get DVR recording status
      operationId: getDvrStatus
      tags:
        - dvr
      responses:
        "200":
          description: Recording status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RecordingStatus"

  /streams/{id}:
    delete:
      summary: Terminate a stream session
      operationId: deleteStreamsId
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Session terminated
        "404":
          description: Session not found

  /logs:
    get:
      summary: Get recent logs
      operationId: getLogs
      responses:
        "200":
          description: Recent log entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/LogEntry"

  /series-rules:
    get:
      summary: List all series recording rules
      operationId: getSeriesRules
      tags:
        - series
      responses:
        "200":
          description: List of rules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SeriesRule"
    post:
      summary: Create a new series rule
      operationId: createSeriesRule
      tags:
        - series
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SeriesRule"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SeriesRule"

  /series-rules/{id}/run:
    post:
      summary: Run a specific series rule immediately
      operationId: runSeriesRule
      tags:
        - series
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: trigger
          in: query
          schema:
            type: string
            default: manual
      responses:
        "200":
          description: Run report
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SeriesRuleRunReport"
        "404":
          description: Rule not found

  /series-rules/run:
    post:
      summary: Run all enabled series rules immediately
      operationId: runAllSeriesRules
      tags:
        - series
      parameters:
        - name: trigger
          in: query
          schema:
            type: string
            default: manual
      responses:
        "200":
          description: List of run reports
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SeriesRuleRunReport"

  /series-rules/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    delete:
      summary: Delete a series rule
      operationId: deleteSeriesRule
      tags:
        - series
      responses:
        "204":
          description: Deleted
        "404":
          description: Rule not found
