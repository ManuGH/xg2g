# yaml-language-server: $schema=./docs/guides/config.schema.json
# xg2g Configuration File (v3.0+)
#
# This file is optional. xg2g is 12-Factor App compliant and can be fully configured via
# environment variables (ENV). This file is useful for complex setups or personal preference.
#
# ENV precedence: ENV > config.yaml > Defaults
#
# To validate your config:
#   xg2g config validate --config /path/to/config.yaml

version: "3.0.0"
configVersion: "3.0.0" # v3 strict validation default; set XG2G_V3_CONFIG_STRICT=false to override

# ------------------------------------------------------------------------------
# Global Settings
# ------------------------------------------------------------------------------
# Log level: debug, info, warn, error
logLevel: "info"

# Data directory for cache, playlists, and recordings
dataDir: "/tmp/xg2g-data"

# ------------------------------------------------------------------------------
# OpenWebIF (Receiver) Configuration [REQUIRED]
# ------------------------------------------------------------------------------
openWebIF:
  # Base URL of your Enigma2 receiver (e.g. http://192.168.1.50)
  baseUrl: "http://127.0.0.1"

  # Optional: HTTP Basic Auth
  # username: "root"
  # password: "password"

  # Connection settings
  timeout: "5s"
  retries: 3

  # Streaming
  # 8001 = Non-transcoded (Direct)
  # 8002 = Transcoded (if supported by receiver)
  streamPort: 8001

  # Use /web/stream.m3u logic? (Recommended: true)
  # If true, asks receiver to generate stream URL (handles 17999 transcoding automatically).
  useWebIFStreams: true

# ------------------------------------------------------------------------------
# Enigma2 (v3 Worker) Client Configuration [OPTIONAL]
# ------------------------------------------------------------------------------
enigma2:
  # Base URL for v3 worker (defaults to openWebIF.baseUrl if empty)
  # baseUrl: "http://127.0.0.1"

  # Optional: HTTP Basic Auth (if required by OpenWebIF)
  # username: "root"
  # password: "password"

  # Request settings
  # timeout: "10s"
  # responseHeaderTimeout: "10s"
  # retries: 2
  # backoff: "200ms"
  # maxBackoff: "2s"

  # Rate limiting (requests/sec)
  # rateLimit: 10
  # rateBurst: 20

  # userAgent: "xg2g-v3"

# ------------------------------------------------------------------------------
# Bouquets (Channel Lists)
# ------------------------------------------------------------------------------
# List of bouquets to include. Case-sensitive matching.
bouquets:
  - "Premium"
  - "Favourites"

# ------------------------------------------------------------------------------
# EPG (Electronic Program Guide)
# ------------------------------------------------------------------------------
epg:
  enabled: true

  # How many days of EPG to fetch (1-14)
  days: 7

  # Path to save/load XMLTV file (Default: xmltv.xml)
  xmltvPath: "xmltv.xml"

  # Maximum Levenshtein distance for fuzzy channel matching (0-5)
  # 0 = exact match only, higher = more lenient matching
  # ENV: XG2G_EPG_FUZZY_MAX
  fuzzyMax: 2

  # EPG Fetch Strategy
  # - "per-service": Fetch EPG for each channel individually (default, compatible with all receivers)
  # - "bouquet": Fetch full bouquet EPG in one request (faster, but may fail on some receivers)
  # ENV: XG2G_EPG_SOURCE
  source: "per-service"

# API Server Configuration
api:
  # Bearer token for API authentication (leave empty to disable)
  # Generate a secure token: openssl rand -hex 32
  # ENV: XG2G_API_TOKEN
  token: ""

  # Scopes for the primary token (v3 RBAC)
  # ENV: XG2G_API_TOKEN_SCOPES
  # tokenScopes:
  #   - v3:read
  #   - v3:write

  # Additional tokens with scopes (v3 RBAC)
  # ENV: XG2G_API_TOKENS
  # tokens:
  #   - token: "read-only-token"
  #     scopes: ["v3:read"]

  # API server listen address
  # ENV: XG2G_LISTEN
  listenAddr: ":8080"

# Prometheus Metrics Configuration
metrics:
  # Enable Prometheus metrics endpoint
  # ENV: XG2G_METRICS_LISTEN (empty disables)
  enabled: true

  # Metrics server listen address
  # ENV: XG2G_METRICS_LISTEN
  listenAddr: ":9090"

# Picons (Channel Logos) Configuration
picons:
  # Base URL for channel logos/picons
  # Example: https://github.com/picons/picons/raw/master/picons
  # ENV: XG2G_PICON_BASE
  baseUrl: ""
# ==============================================================================
# Advanced Configuration Examples
# ==============================================================================

# Example 1: Minimal configuration (OpenWebIF only)
# ---
# openWebIF:
#   baseUrl: "http://192.168.1.100"

# Example 2: Full EPG setup with authentication
# ---
# openWebIF:
#   baseUrl: "http://dreambox.local"
#   username: "admin"
#   password: "secret"
# epg:
#   enabled: true
#   days: 7
#   maxConcurrency: 5
#   xmltvPath: "xmltv.xml"

# Example 3: Multiple bouquets with custom API token
# ---
# openWebIF:
#   baseUrl: "http://192.168.1.100"
# bouquets:
#   - "1:7:1:0:0:0:0:0:0:0:FROM BOUQUET \"favorites.tv\" ORDER BY bouquet"
#   - "1:7:1:0:0:0:0:0:0:0:FROM BOUQUET \"sports.tv\" ORDER BY bouquet"
# api:
#   token: "your-secure-token-here"
#   listenAddr: ":8080"
# metrics:
#   enabled: true
#   listenAddr: ":9090"

# Example 4: High-performance EPG collection
# ---
# openWebIF:
#   baseUrl: "http://192.168.1.100"
#   timeout: "30s"
#   retries: 5
#   maxBackoff: "60s"
# epg:
#   enabled: true
#   days: 7
#   maxConcurrency: 10
#   timeoutMs: 60000
#   retries: 3
#   fuzzyMax: 3

# ==============================================================================
# Environment Variable Reference
# ==============================================================================
#
# All configuration options can be overridden via environment variables:
#
# Application:
#   XG2G_DATA                    - Data directory path
#   XG2G_LOG_LEVEL               - Log level (debug, info, warn, error)
#
# OpenWebIF:
#   XG2G_OWI_BASE                - Base URL (REQUIRED)
#   XG2G_OWI_USER                - Username for authentication
#   XG2G_OWI_PASS                - Password for authentication
#   XG2G_OWI_TIMEOUT_MS          - Request timeout in milliseconds
#   XG2G_OWI_RETRIES             - Maximum retry attempts
#   XG2G_OWI_BACKOFF_MS          - Initial backoff delay in milliseconds
#   XG2G_OWI_MAX_BACKOFF_MS      - Maximum backoff delay in milliseconds
#   XG2G_STREAM_PORT             - Stream port number
#   XG2G_USE_WEBIF_STREAMS       - Use /web/stream.m3u URLs (true/false)
#
# Bouquets:
#   XG2G_BOUQUET                 - Comma-separated list of bouquet names
#
# EPG:
#   XG2G_EPG_ENABLED             - Enable EPG (true/false)
#   XG2G_EPG_DAYS                - Days of EPG data (1-14)
#   XG2G_EPG_MAX_CONCURRENCY     - Max concurrent requests (1-10)
#   XG2G_EPG_TIMEOUT_MS          - EPG request timeout in milliseconds
#   XG2G_EPG_RETRIES             - EPG retry attempts
#   XG2G_FUZZY_MAX               - Fuzzy match distance (0-10)
#   XG2G_XMLTV                   - XMLTV output file path (relative to dataDir)
#
# API:
#   XG2G_API_TOKEN               - Bearer token for API authentication
#   XG2G_API_TOKEN_SCOPES        - Scopes for the primary token (v3 RBAC)
#   XG2G_API_TOKENS              - Additional tokens with scopes (v3 RBAC)
#   XG2G_LISTEN                  - API listen address
#
# Metrics:
#   XG2G_METRICS_LISTEN          - Metrics listen address (empty disables)
#
# Picons:
#   XG2G_PICON_BASE              - Base URL for channel logos
#
# v3 (/api/v3/*; env-first, enigma2 also configurable via config.yaml):
#   XG2G_V3_WORKER_ENABLED       - Enable v3 worker/store
#   XG2G_V3_WORKER_MODE          - Worker mode (standard or virtual)
#   XG2G_CONFIG_VERSION          - Config schema version for v3 strict validation
#   XG2G_V3_CONFIG_STRICT        - Enable strict v3 config validation
#   XG2G_V3_STORE_BACKEND        - Store backend (memory or bolt)
#   XG2G_V3_STORE_PATH           - Store path for bolt backend
#   XG2G_V3_HLS_ROOT             - HLS output root for v3 sessions
#   XG2G_V3_SHADOW_INTENTS       - Enable shadow intents from v2 proxy
#   XG2G_V3_SHADOW_TARGET        - Shadow intents target URL
#   XG2G_V3_E2_HOST              - Enigma2 receiver base URL (defaults to XG2G_OWI_BASE)
#   XG2G_V3_E2_USER              - Enigma2 username (v3)
#   XG2G_V3_E2_PASS              - Enigma2 password (v3)
#   XG2G_V3_E2_TIMEOUT           - Enigma2 HTTP timeout (e.g., 10s)
#   XG2G_V3_E2_RESPONSE_HEADER_TIMEOUT - Enigma2 response header timeout (e.g., 10s)
#   XG2G_V3_E2_RETRIES           - Enigma2 retry attempts
#   XG2G_V3_E2_BACKOFF           - Enigma2 retry backoff (e.g., 200ms)
#   XG2G_V3_E2_MAX_BACKOFF       - Enigma2 max backoff (e.g., 2s)
#   XG2G_V3_E2_RATE_LIMIT        - Enigma2 rate limit (req/sec)
#   XG2G_V3_E2_RATE_BURST        - Enigma2 burst capacity
#   XG2G_V3_E2_USER_AGENT        - Enigma2 User-Agent
#
# ==============================================================================
# Usage Examples
# ==============================================================================
#
# 1. Using config file:
#    ./xg2g-daemon --config config.yaml
#
# 2. Using environment variables only:
#    XG2G_OWI_BASE=http://192.168.1.100 \
#    XG2G_EPG_ENABLED=true \
#    ./xg2g-daemon
#
# 3. Mixed (ENV overrides config file):
#    XG2G_EPG_DAYS=7 ./xg2g-daemon --config config.yaml
#
# 4. Check version:
#    ./xg2g-daemon --version
#
# ==============================================================================
# Troubleshooting
# ==============================================================================
#
# - If OpenWebIF connection fails, verify the baseUrl is accessible:
#     curl http://192.168.1.100/api/statusinfo
#
# - For EPG issues, check Enigma2 supports EPG API:
#     curl http://192.168.1.100/api/epgservice?sRef=REFERENCE
#
# - Streams: In der Regel `useWebIFStreams: true` verwenden, damit die Box intern
#   Direct vs. Relay entscheidet (8001/17999 sind dann intern und f√ºr xg2g egal).
#
# - Enable debug logging for detailed information:
#     XG2G_LOG_LEVEL=debug ./xg2g-daemon --config config.yaml
#
# - Check metrics at: http://localhost:9090/metrics
#
# - Health check: curl http://localhost:8080/healthz
# - API health (auth): curl -H "Authorization: Bearer <token>" http://localhost:8080/api/v2/system/health
#
