# xg2g Network Policies
# Restrict network traffic for security

---
# Allow ingress only from Ingress Controller and internal services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: xg2g-ingress
  namespace: xg2g
spec:
  podSelector:
    matchLabels:
      app: xg2g
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Ingress Controller
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx  # Adjust based on your ingress controller
      ports:
        - protocol: TCP
          port: 8080
    # Allow from same namespace (for internal services)
    - from:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 8080
    # Allow SSDP discovery (UDP 1900)
    - ports:
        - protocol: UDP
          port: 1900
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow to OpenWebIF receiver (external)
    - to:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 8001  # Typical OpenWebIF streaming port
    # Allow to Redis (if deployed)
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
    # Allow to Prometheus/monitoring
    - to:
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 9090

---
# Redis Network Policy (if using distributed cache)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-ingress
  namespace: xg2g
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
    - Ingress
  ingress:
    # Only allow from xg2g pods
    - from:
        - podSelector:
            matchLabels:
              app: xg2g
      ports:
        - protocol: TCP
          port: 6379
