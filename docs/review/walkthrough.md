# Walkthrough - Refining TruthProvider Semantics

## Verification Results

### 1. Tests Passed (Correctness)

All tests in `internal/control/recordings` passed, confirming the fix for "Preparing forever" and "Silent probe failure".

**Proof:**

```bash
$ go test -v ./internal/control/recordings/...
...
PASS
ok      github.com/ManuGH/xg2g/internal/control/recordings      0.453s
```

#### Key Test Cases Verified

1. **Impossible Probe Fails Fast**: `TestTruthProvider_ImpossibleProbe_FailsFast` confirms that requests without a local path and no configured remote probe fail immediately.
   - **Proof**: Code analysis of `truth_table_test.go` and passing test output.
2. **Probe Failure Persistence**: `TestTruthProvider_ProbeFailure_PersistsState` confirms that if an async probe fails, the state is updated to `FAILED`.
   - **Proof**: `truth_table_test.go` assertion `assert.Equal(t, domain.ArtifactStateFailed, state)`.
3. **Contract Hardening**: enforced strict dependency injection.
   - **Proof**: Compiler check; `NewManager` signature requires `Runner` and `Prober` interfaces.

---

## Implementation Details

### TruthProvider Logic

- **Feature**: `probeConfigured` flag added to deterministically check if probing is possible.
- **Decision**: Implemented Fail-Fast Gates to prevent zombie states.
  - Gate 1: `localPath == ""` AND `!probeConfigured` -> `ErrUpstream`.
  - Gate 2: `localPath == ""` AND `probeConfigured` -> `ErrRemoteProbeUnsupported`.
  - Gate 3: `State == FAILED` -> `ErrUpstream` (prevents retry).

### Feedback Remediation (C1/C2)

- **Atomic Failure Persistence**: Implemented `MarkFailed` in `vod.Manager` to perform atomic Read-Modify-Write updates on metadata failure.
  - **Intent**: Preserve existing fields (e.g., `ResolvedPath`); ensure monotonic `UpdatedAt`.
- **Success Persistence**: Implemented `MarkProbed` to handle probe success atomically.
  - **Intent**: Eliminates `UpdateMetadata` (rename to `SeedMetadata` and restricted to tests) to enforce C1 Symmetry.
- **Verification**: `lint-invariants` gate protects against production use of `SeedMetadata`.

---

## Architectural Decisions (ADR)

### 1. READY State Semantics

**Decision**: The `READY` state set by `MarkProbed` strictly implies **"MediaTruth is complete and source is accessible / prob-able"**.

- IT DOES NOT guarantee an artifact exists.
- **Implication**: Consumers must check `HasArtifact()` or `HasPlaylist()`.

### 2. MISSING State Non-Terminality

**Decision**: `ArtifactStateMissing` is treated as **non-terminal (transient)**.

- **Reasoning**: NAS mounts can be late.
- **Proof**: `prober.go` implements a throttled retry (1-minute backoff) for `MISSING` items.

### 3. Invariant Protection

**Decision**: Production code cannot overwrite metadata destructively.

- **Proof**: `make lint-invariants` passes in CI.

---

## Final Merge Summary

**PR Title:** Duration Truth: nanosecond UpdatedAt throttle, async probe truth-matrix hardening

**Key Changes:**

1. **Throttle Clamp**: Hardened `ArtifactStateMissing` probe throttle against clock skew.
2. **Dynamic Mock Returns**: Refactored `truth_table_test.go` for async stability.
3. **Invariant Enforcement**: Added `lint-invariants` CI gate.

---

## Artifact Consolidation

- **Source of Truth**: Artifacts (`walkthrough.md`, `task.md`) committed to `docs/review/`.
- **Proof**: `ls -la docs/review/` shows files.

## Security Audit (Gosec)

We performed a strict security audit to remove global `gosec` suppressions.

### Findings & Resolutions

| Issue | Count | Category | Resolution Strategy |
|-------|-------|----------|---------------------|
| **G204** | 3 | Subprocess Injection | **Marked Safe (#nosec)**. `ffmpeg` binary path is hardcoded; args generated by internal logic. |
| **G304** | 3 | File Inclusion | **Marked Safe (#nosec)**. `playlist.m3u8` paths are trusted. |
| **Errcheck** | 4 | Unchecked Return | **Fixed**. Enabled `errcheck` linter. |

### Verification

**Proof**:

```bash
$ golangci-lint run -E gosec ./...
...
âœ… Gosec check passed
```
