# xg2g v1.3.0 Deployment Guide

## 🎯 Overview

**Version**: v1.3.0
**Release Date**: 2025-01-XX
**Major Feature**: Optional Audio Transcoding for Jellyfin Direct Play

## 🆕 What's New

### Audio Transcoding Feature

Solves the audio/video desynchronization issue in Jellyfin by transcoding MP2/AC3 audio to AAC **before** it reaches Jellyfin.

**Problem Solved:**
- ❌ **Before**: Jellyfin "Mixed-Mode Remuxing" → Video Direct + Audio Transcode → 3-6s audio delay
- ✅ **After**: xg2g transcodes audio → Jellyfin Direct Play → No delay → Perfect sync

**Benefits:**
- 🎵 Perfect audio/video synchronization in Jellyfin
- 📱 Enables AV1 mobile transcoding (both codecs transcoded together)
- 🌐 Universal browser compatibility (AAC everywhere)
- ⚡ Low overhead (~10-15% CPU per stream)

## 📦 Deployment Steps

### 1. Wait for Docker Image

**Check GitHub Actions:**
```bash
gh run list --limit 1
```

Wait until all workflows show: ✅ **completed**

**Verify Docker image:**
```bash
docker pull ghcr.io/manugh/xg2g:latest
docker pull ghcr.io/manugh/xg2g:v1.3.0
```

### 2. SSH to Production Server

```bash
ssh dockeruser@10.10.55.50
cd /opt/stacks/xg2g
```

### 3. Update docker-compose.yml

Add audio transcoding configuration:

```yaml
services:
  xg2g:
    image: ghcr.io/manugh/xg2g:v1.3.0  # or :latest
    ports:
      - "8080:8080"
      - "9090:9090"
      - "18000:18000"  # Already configured
    environment:
      # ... existing settings ...

      # NEW: Audio Transcoding (v1.3.0)
      - XG2G_ENABLE_AUDIO_TRANSCODING=true
      - XG2G_AUDIO_CODEC=aac
      - XG2G_AUDIO_BITRATE=192k
      - XG2G_AUDIO_CHANNELS=2
```

### 4. Update .env (Alternative)

Or add to `.env` file:

```bash
# Audio Transcoding (v1.3.0)
XG2G_ENABLE_AUDIO_TRANSCODING=true
XG2G_AUDIO_CODEC=aac
XG2G_AUDIO_BITRATE=192k
XG2G_AUDIO_CHANNELS=2
```

### 5. Deploy

```bash
# Pull new image
docker-compose pull

# Restart with new version
docker-compose down
docker-compose up -d

# Check logs
docker-compose logs -f xg2g
```

### 6. Verify Audio Transcoding

**Check logs for confirmation:**
```bash
docker logs xg2g 2>&1 | grep "audio transcoding enabled"
```

Expected output:
```json
{"level":"info","codec":"aac","bitrate":"192k","channels":2,"message":"audio transcoding enabled"}
```

**Verify stream URLs use proxy port:**
```bash
curl -s http://10.10.55.50:8080/files/playlist.m3u | grep "http://" | head -3
```

Expected: All URLs should use port `18000` (proxy with transcoding)

## ✅ Testing

### 1. Test in VLC (Baseline)

```bash
# VLC should play perfectly (as before)
vlc http://10.10.55.50:8080/files/playlist.m3u
```

✅ Expected: Perfect sync (VLC always worked)

### 2. Test in Jellyfin

#### A. Play a channel in Jellyfin

#### B. Check playback info

- Press `Ctrl+Alt+Shift+D` (web) or check playback settings
- Look for:

  ```text
  Video: H264 (direct)
  Audio: AAC (direct)  ← This is the key!
  ```

#### C. Verify synchronization
- ✅ Audio and video should be perfectly in sync
- ✅ No 3-6 second delay anymore

### 3. Test Mobile/Remote (Optional)

**Enable AV1 in Jellyfin:**
1. Dashboard → Playback → Transcoding
2. ✅ Enable: "Allow AV1 encoding"
3. Set: Hardware acceleration = VAAPI

**Test on mobile:**
- Should transcode to AV1+AAC (both synchronized)
- No audio delay

## 📊 Monitoring

### Performance Metrics

**CPU Usage:**
```bash
docker stats xg2g --no-stream
```

Expected increase:
- Per active stream: +10-15% CPU
- 5 concurrent streams: ~50-75% CPU total

**Memory Usage:**
```bash
docker stats xg2g --format "{{.MemUsage}}"
```

Expected:
- Base: ~30-50MB
- Per stream: +20MB
- 5 streams: ~130-150MB total

### Logs

**Monitor transcoding activity:**
```bash
docker logs xg2g -f 2>&1 | grep -E "(transcoding|ffmpeg)"
```

**Check for errors:**
```bash
docker logs xg2g --tail 100 | grep -i error
```

## 🔧 Troubleshooting

### Issue 1: Audio Still Delayed

**Check:**
1. Verify transcoding is enabled:
   ```bash
   docker logs xg2g 2>&1 | grep "audio transcoding enabled"
   ```

2. Verify streams use proxy port (18000):
   ```bash
   curl -s http://10.10.55.50:8080/files/playlist.m3u | grep "18000" | wc -l
   ```
   Should match channel count (133)

3. Check Jellyfin receives AAC:
   - Playback info must show "Audio: AAC (direct)"
   - If it shows "Audio: AAC" (without "direct"), transcoding is still happening

**Solution:**
- Ensure proxy is enabled: `XG2G_ENABLE_STREAM_PROXY=true`
- Ensure Smart Stream Detection found proxy: Check logs for "detected optimal stream endpoint"

### Issue 2: FFmpeg Errors

**Symptom:** Streams fail to start or break

**Check:**
```bash
docker logs xg2g 2>&1 | grep ffmpeg
```

**Common errors:**
- `ffmpeg not found`: Image version < v1.3.0, update image
- `Invalid codec`: Check `XG2G_AUDIO_CODEC` is `aac` or `mp3`
- `Pipe broken`: Client disconnected (normal)

### Issue 3: High CPU Usage

**If CPU > 80%:**

1. Lower bitrate:
   ```bash
   XG2G_AUDIO_BITRATE=128k  # Instead of 192k
   ```

2. Monitor concurrent streams:
   ```bash
   # Count active ffmpeg processes
   docker exec xg2g ps aux | grep ffmpeg | wc -l
   ```

3. Limit concurrent clients in Jellyfin

### Issue 4: No Audio in Playback

**Check:**
1. Original stream has audio:
   ```bash
   ssh dockeruser@10.10.55.50
   ffprobe http://10.10.55.57:17999/[service-ref]
   ```

2. FFmpeg can process stream:
   ```bash
   docker exec xg2g ffmpeg -i "http://10.10.55.57:17999/[service-ref]" -t 5 -f null - 2>&1 | grep Audio
   ```

## 🔄 Rollback Plan

**If issues occur, rollback to v1.2.0:**

```bash
# SSH to server
ssh dockeruser@10.10.55.50
cd /opt/stacks/xg2g

# Edit docker-compose.yml
nano docker-compose.yml
# Change: image: ghcr.io/manugh/xg2g:v1.2.0

# Restart
docker-compose down
docker-compose up -d

# Verify
docker logs xg2g | head -20
```

**Or disable transcoding only:**

```bash
# Remove/comment audio transcoding from docker-compose.yml:
# - XG2G_ENABLE_AUDIO_TRANSCODING=true
# - XG2G_AUDIO_CODEC=aac
# - XG2G_AUDIO_BITRATE=192k

docker-compose down && docker-compose up -d
```

## 📈 Success Criteria

✅ **Deployment Successful if:**

1. **Logs show transcoding enabled:**

   ```json
   {"level":"info","codec":"aac","bitrate":"192k","channels":2,"message":"audio transcoding enabled"}
   ```

2. **Jellyfin shows Direct Play:**

   ```text
   Video: H264 (direct)
   Audio: AAC (direct)
   ```

3. **Audio/Video are synchronized** (no delay)

4. **CPU usage acceptable:**
   - Idle: <10%
   - 1 stream: <25%
   - 5 streams: <75%

5. **All 133 channels playable** in Jellyfin

## 📚 Documentation

- **Feature Guide**: [docs/features/AUDIO_TRANSCODING.md](../features/AUDIO_TRANSCODING.md)
- **Threadfin Integration**: [docs/guides/THREADFIN.md](../guides/THREADFIN.md)
- **Changelog**: [docs/CHANGELOG.md](../CHANGELOG.md)

## 🎯 Expected User Experience

### Before v1.3.0
- ❌ Audio delayed 3-6 seconds in Jellyfin
- ❌ VLC worked perfectly (confusing!)
- ❌ Mobile transcoding issues
- ❌ "Mixed-Mode Remuxing" in logs

### After v1.3.0
- ✅ Perfect audio/video sync in Jellyfin
- ✅ Direct Play (no transcoding delay)
- ✅ Mobile AV1 transcoding works (synchronized)
- ✅ Universal browser compatibility

## 🚀 Post-Deployment

### 1. Update Jellyfin Settings

**Enable AV1 for mobile:**
1. Dashboard → Playback → Transcoding
2. ✅ Allow AV1 encoding
3. Hardware acceleration: VAAPI
4. Save

### 2. Test All Workflows

**Local WLAN (Direct Play):**
- Open Jellyfin in Chrome/Firefox
- Play any channel
- Verify: "Direct Play" in playback info
- Check: Perfect audio/video sync

**Mobile/Remote (AV1 Transcode):**
- Open Jellyfin app on phone
- Play any channel
- Verify: Smooth playback
- Check: Audio/video synchronized

### 3. Monitor for 24h

**Check metrics:**
```bash
# CPU/Memory trends
docker stats xg2g

# Error rate
docker logs xg2g | grep -i error | wc -l

# Active streams
docker exec xg2g ps aux | grep ffmpeg | wc -l
```

## ✨ Summary

**What Changed:**
- Added FFmpeg to Docker image (~20MB)
- Integrated audio transcoding in proxy
- New environment variables for configuration
- Comprehensive documentation

**User Impact:**
- 🎵 **Perfect audio sync in Jellyfin** (main goal!)
- 📱 Mobile streaming works better
- 🌐 Better browser compatibility
- ⚡ Low resource overhead

**Next Steps:**
1. Wait for CI/CD to complete
2. Deploy to production server (10.10.55.50)
3. Enable audio transcoding
4. Test in Jellyfin
5. Verify perfect synchronization
6. Enjoy synchronized Live TV! 🎉

---

**Questions/Issues:**
- GitHub Issues: https://github.com/ManuGH/xg2g/issues
- Discussions: https://github.com/ManuGH/xg2g/discussions

**Deployed by**: dockeruser@10.10.55.50
**Test by**: Playing channels in Jellyfin and checking for "AAC (direct)"
