# ADR-009.1: Playback Decision Spec Patch (Repair)

**Status:** Accepted
**Date:** 2026-01-23
**Parent:** [ADR-009](009-playback-decision-spec.md)
**Triggers:** Red Team Findings (Spec Breaks 001, 002, 003)

## Context

Operation Black Mirror (Phase R1) identified three critical flaws in ADR-009:

1. **Incompleteness**: Codec strings (`h264`) ignore profiles/levels, leading to false positives (Client Crash).
2. **Precedence Hole**: "Container Mismatch" Rule wrongly blocked DirectStream.
3. **Terminology Drift**: "Unknown" was ambiguous, risking Deny for forward-compatible content.

This Patch-ADR normatively overrides portions of ADR-009.

## 1. Scope Limitation (Codec Granularity)

**Refers to Break 001 (Critical)**

The Decision Engine strictly operates on **MIME-type equivalent strings** (e.g., `h264`, `hevc`, `aac`).
**Normative Constraint:**

- The Engine explicitly **DOES NOT** verify Codec Profiles (e.g., High vs Baseline) or Levels (e.g., 4.1 vs 5.2).
- A decision of `DirectPlay` or `DirectStream` asserts only *Format Compatibility*, not *Decoding Capability*.
- **Operator Responsibility**: Operators must ensure source content typically matches client hardware profiles (i.e., "Baseline Compatibility"). Use of exotic profiles with standard codec strings is "Undefined Behavior".
- **Client Rejection**: Clients MAY still reject playback after a positive decision; this is not considered an engine fault.

## 2. Terminology Repair

**Refers to Break 003 (High)**

The term "Unknown" is effectively removed. We distinguish:

| Term | Definition | Semantics | Engine Behavior |
|---|---|---|---|
| **Missing** | Field is empty string `""` or nil | Validation Failure | **HTTP 400 (Bad Request)** |
| **Unrecognized** | Valid string, but not in any internal whitelist/capabilities | Mismatch | **Fallback to Transcode** (Rule 2/3) |
| **Unsupported** | Known string, but not in Client Capabilities | Mismatch | **Fallback to Transcode** (Rule 2/3) |

**Invariant:**
The Engine **MUST NOT** Deny a valid source codec string solely because it is not in the Engine's internal static whitelist (Preventing Forward-Compatibility Blocking).

## 3. Revised Decision Rules (Precedence)

**Refers to Break 002 (High)**

The precedence order is redefined to decouple Container (Transport) from Stream (Payload) checks.

| Order | Rule Name | Logic | Verdict |
|---|---|---|---|
| 1 | **Validation** | `Missing` required fields | **400 Error** |
| 2 & 3 | **Codec Matching** | `Source.Video` not in `Caps.Video` OR `Source.Audio` not in `Caps.Audio` | **Transcode Needed** (Jump to Rule 6) |
| 4 | **DirectPlay** | `Source.Container` in `Caps.Containers` AND `Protocol Constraints` (e.g. Range, MP4/MOV) | **DirectPlay** |
| 5 | **DirectStream** | `Caps.SupportsHLS` AND `CanVideo` AND `CanAudio` (Container is irrelevant) | **DirectStream** |
| 6 | **Transcode** | `Policy.AllowTranscode` == true | **Transcode** |
| 7 | **Policy Deny** | `Transcode Needed` BUT `Policy.AllowTranscode` == false | **Deny** (`ReasonPolicyDeniesTranscode`) |
| 8 | **Default Deny** | No path found | **Deny** (`ReasonNoCompatiblePlaybackPath`) |

**Mapping Table (Old -> New):**

| Old Rule | New Rule | Change |
|---|---|---|
| R1: Container Mismatch -> "Fail Checks" | R4: DirectPlay Check | Container Mismatch only fails **DirectPlay**. Does NOT block DirectStream/Transcode. |
| R1 "Unknown" Semantics -> Deny | R1: Validation | Empty string = 400. Unrecognized string = Codec Mismatch (Transcode). |
| R5: DirectStream | R5: DirectStream | Now strictly evaluated **after** Mismatch checks (R2/3) but **independent** of Container check (R4). |

## 4. Non-Goals

1. **Profile/Level Matching**: The engine will not parse AVC/HEVC configuration records to determining levels.
2. **Bitrate/Resolution Constraints**: Currently purely opaque "Pass-through" (Phase 4 scope).

## 5. Consequences

1. **Engine Update**: `evaluateDecision` must stop "accumulating" rejection for Container Mismatch and instead treat it as a filter for DirectPlay only.
2. **Model Update**: Reference Model must allow `DirectStream` even if `CanContainer` is false.
3. **Proof Update**: Current "Fail Checks" property on Container Mismatch is **invalid** and must be removed/updated.
