version: "3.8"

services:
  xg2g:
    # NOTE: Build with 'make docker-build' to create this image
    image: xg2g:latest
    pull_policy: never
    container_name: xg2g

    # Run as root for internal testing simplicity (or use specific UID if needed)
    user: "${DOCKER_USER:-0:0}"

    # Use host networking for best compatibility (SSDP, etc.)
    network_mode: host

    # Alternative: Bridge mode (if you comment out network_mode: host)
    # ports:
    #   - "8080:8080" # API
    #   - "9090:9090" # Metrics

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - NET_BIND_SERVICE

    # Mounts for data and V3 store/HLS
    volumes:
      - ./data:/data
      - ./data/v3-store:/data/v3-store
      - ./data/v3-hls:/data/v3-hls

    environment:
      # Data Directory
      - XG2G_DATA=/data

      # Logging
      - XG2G_LOG_LEVEL=${XG2G_LOG_LEVEL:-info}

      # API Server
      - XG2G_LISTEN=:8080

      # Metrics
      - XG2G_METRICS_LISTEN=:9090

      # Security & Limits
      - XG2G_API_TOKEN=
      - XG2G_AUTH_ANONYMOUS=true
      - XG2G_API_TOKEN_SCOPES=${XG2G_API_TOKEN_SCOPES:-*}

      # OpenWebIF (Can be empty for Setup Mode)
      - XG2G_OWI_BASE=${XG2G_OWI_BASE:-}
      - XG2G_OWI_USER=${XG2G_OWI_USER:-}
      - XG2G_OWI_PASS=${XG2G_OWI_PASS:-}

      # Bouquets (Optional, comma-separated. Empty = All)
      - XG2G_BOUQUET=${XG2G_BOUQUET:-}

      # Main Configuration
      - XG2G_INITIAL_REFRESH=false
      - XG2G_USE_WEBIF_STREAMS=true
      - XG2G_V3_WORKER_ENABLED=true
      - XG2G_V3_WORKER_MODE=standard
      - XG2G_V3_CONFIG_STRICT=false
      - XG2G_V3_STORE_BACKEND=memory
      # Persistent Store (Example configuration for BoltDB)
      # - XG2G_V3_STORE_BACKEND=bolt
      # - XG2G_V3_STORE_PATH=/data/v3-store/xg2g.db

      - XG2G_V3_HLS_ROOT=/data/v3-hls

      # Tuning
      - XG2G_V3_TUNE_TIMEOUT=10s

      # FFmpeg
      - XG2G_V3_FFMPEG_BIN=ffmpeg
      - XG2G_V3_FFMPEG_KILL_TIMEOUT=5s

      # Dev Mode (Hot Reloading UI if mounted, otherwise serves dist)
      - XG2G_DEV=false

    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8080/healthz"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 2s

    restart: unless-stopped
