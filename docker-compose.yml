# xg2g - Enigma2 to IPTV Gateway
# Unified Configuration: All 3 Modes in One File
#
# Choose your mode by uncommenting the desired configuration:
#
# MODE 1: Standard (Desktop Players) - DEFAULT
#   - No audio transcoding
#   - Original streams (AC3/MP2)
#   - Works with: VLC, Kodi, Plex, Jellyfin on Desktop
#
# MODE 2: Audio Transcoding (iPhone/iPad)
#   - Stream proxy with audio transcoding (AC3/MP2 â†’ AAC)
#   - Ultra-fast Rust remuxer (1.4ms latency, <0.1% CPU)
#   - Works with: iPhone Safari, iPad Safari
#
# MODE 3: GPU Transcoding (Full Video+Audio)
#   - Hardware-accelerated video transcoding (VAAPI)
#   - Requires: Intel Quick Sync or AMD GPU
#   - Works with: All devices, any format
#
# =============================================================================
# RUNNING IN LXC (Proxmox, etc.)
# =============================================================================
# If running Docker inside an LXC container, use the LXC override:
#   docker compose -f docker-compose.yml -f docker-compose.lxc.yml up -d
#
# This is required due to LXC's sysctl restrictions with port mappings.
# See docs/runtime-lxc.md for detailed explanation and setup guide.

services:
  xg2g:
    image: ghcr.io/manugh/xg2g:latest
    container_name: xg2g

    # ===========================================================================
    # PORTS - Same for all modes
    # ===========================================================================
    ports:
      - "8080:8080"      # HTTP API & M3U/EPG (always needed)
      - "18000:18000"    # Stream Proxy (MODE 2 & 3 only)
      # - "8085:8085"    # GPU Transcoder (MODE 3 only) - Uncomment for GPU mode
      - "1900:1900/udp"  # SSDP for Plex/Jellyfin auto-discovery (optional)
      # - "9090:9090"    # Prometheus metrics (optional)

    # ===========================================================================
    # GPU ACCESS - Uncomment for MODE 3 only
    # ===========================================================================
    # devices:
    #   - /dev/dri:/dev/dri    # GPU device for VAAPI

    # ===========================================================================
    # SECURITY SETTINGS - Same for all modes
    # ===========================================================================
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,nodev,size=100m   # 100MB for MODE 1+2, use 1g for MODE 3

    ulimits:
      nofile:
        soft: 4096
        hard: 8192
      nproc:
        soft: 512
        hard: 1024

    # ===========================================================================
    # ENVIRONMENT VARIABLES
    # ===========================================================================
    environment:
      # -------------------------------------------------------------------------
      # REQUIRED CONFIGURATION (All Modes)
      # -------------------------------------------------------------------------
      - XG2G_OWI_BASE=http://192.168.1.100
      - XG2G_OWI_USER=root
      - XG2G_OWI_PASS=yourpassword
      - XG2G_BOUQUET=Favourites
      - XG2G_INITIAL_REFRESH=true         # Auto-load channels on startup

      # =========================================================================
      # MODE 1: STANDARD (DEFAULT) - Desktop Players
      # =========================================================================
      # No additional configuration needed!
      # This mode is active by default.
      # - No audio transcoding
      # - Original streams (AC3/MP2)
      # - Lowest CPU usage

      # =========================================================================
      # MODE 2: AUDIO TRANSCODING - iPhone/iPad Safari
      # =========================================================================
      # Uncomment these lines to enable audio transcoding:

      # - XG2G_ENABLE_STREAM_PROXY=true
      # - XG2G_PROXY_LISTEN=:18000
      # Audio transcoding is automatically enabled when proxy is enabled
      # Rust remuxer is used automatically (1.4ms latency, <0.1% CPU)

      # Optional: Audio settings (defaults shown)
      # - XG2G_AUDIO_CODEC=aac
      # - XG2G_AUDIO_BITRATE=192k
      # - XG2G_AUDIO_CHANNELS=2

      # =========================================================================
      # MODE 3: GPU TRANSCODING - Full Video+Audio Hardware Acceleration
      # =========================================================================
      # Uncomment these lines to enable GPU transcoding:

      # - XG2G_ENABLE_STREAM_PROXY=true
      # - XG2G_PROXY_LISTEN=:18000
      # - XG2G_GPU_TRANSCODE=true
      # - XG2G_GPU_LISTEN=0.0.0.0:8085
      # - XG2G_VAAPI_DEVICE=/dev/dri/renderD128

      # Optional: Video settings (defaults shown)
      # - XG2G_VIDEO_BITRATE=4M
      # - XG2G_AUDIO_BITRATE=192k

      # IMPORTANT: Also uncomment "devices:" and port 8085 above!
      #
      # NOTE: If both MODE 2 and MODE 3 are enabled, GPU takes priority:
      #   Priority 1: GPU transcoding (video + audio)
      #   Priority 2: Rust remuxer (audio only)
      #   Priority 3: FFmpeg fallback

      # =========================================================================
      # SMART STREAM DETECTION (All Modes)
      # =========================================================================
      # Automatically selects optimal port (8001 vs 17999) per channel
      # Enabled by default, no configuration needed!
      #
      # To disable: - XG2G_SMART_STREAM_DETECTION=false
      # To set manual target: - XG2G_PROXY_TARGET=http://192.168.1.100:8001

      # =========================================================================
      # ADVANCED: Manual Overrides (Rarely Needed)
      # =========================================================================
      # These are auto-configured based on the mode you choose above:
      #
      # - XG2G_ENABLE_AUDIO_TRANSCODING=true  # Auto-enabled with STREAM_PROXY
      # - XG2G_USE_RUST_REMUXER=true          # Default: true (140x faster than FFmpeg)
      # - XG2G_FFMPEG_PATH=/usr/bin/ffmpeg    # Fallback if Rust unavailable
      #
      # You typically don't need to set these manually.

      # =========================================================================
      # OPTIONAL FEATURES (All Modes)
      # =========================================================================
      # - XG2G_EPG_ENABLED=false                  # Disable EPG collection
      # - XG2G_EPG_DAYS=7                         # EPG days (1-14)
      # - XG2G_HDHR_ENABLED=false                 # Disable HDHomeRun emulation
      # - XG2G_API_TOKEN=your-token-here          # API authentication
      # - XG2G_PICON_BASE=http://picons-url       # Custom picons URL

    # ===========================================================================
    # VOLUMES
    # ===========================================================================
    volumes:
      - xg2g-data:/data

    # ===========================================================================
    # HEALTH CHECK
    # ===========================================================================
    # Basic health check (liveness probe)
    # For detailed status with component checks, use: /healthz?verbose=true
    # Checks: receiver connectivity, channels loaded, EPG status, playlist files
    healthcheck:
      test: wget -q -T 5 -O /dev/null http://localhost:8080/healthz || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    restart: unless-stopped

# =============================================================================
# ACCESS URLS
# =============================================================================
#
# MODE 1 (Standard):
#   M3U Playlist:  http://localhost:8080/files/playlist.m3u
#   EPG (XMLTV):   http://localhost:8080/xmltv.xml
#   API Status:    http://localhost:8080/api/v1/status
#
# MODE 2 (Audio Transcoding):
#   Stream Proxy:  http://localhost:18000/1:0:19:... (use in iPhone Safari)
#   M3U Playlist:  http://localhost:8080/files/playlist.m3u
#   EPG (XMLTV):   http://localhost:8080/xmltv.xml
#
# MODE 3 (GPU Transcoding):
#   Stream Proxy:  http://localhost:18000/1:0:19:... (transcoded streams)
#   GPU Direct:    http://localhost:8085/transcode?source_url=...
#   GPU Health:    http://localhost:8085/health
#   M3U Playlist:  http://localhost:8080/files/playlist.m3u
#
# =============================================================================
# QUICK START
# =============================================================================
#
# 1. Edit this file:
#    - Set XG2G_OWI_BASE, XG2G_OWI_USER, XG2G_OWI_PASS, XG2G_BOUQUET
#    - Uncomment the mode you want (MODE 1 is default)
#
# 2. Start:
#    docker compose -f docker-compose.unified.yml up -d
#
# 3. Access:
#    - MODE 1: http://localhost:8080/files/playlist.m3u
#    - MODE 2: http://localhost:18000/1:0:19:...
#    - MODE 3: http://localhost:18000/1:0:19:...
#
# =============================================================================
# GPU REQUIREMENTS (MODE 3 only)
# =============================================================================
#
# Intel:
#   - 6th gen Core (Skylake) or newer
#   - Install: intel-media-driver or i965-va-driver
#   - Verify: vainfo (should show VAEntrypointEncSlice)
#
# AMD:
#   - Radeon RX 400 series or newer
#   - Install: mesa-va-drivers
#   - Verify: vainfo (should list AMD encoders)
#
# Test GPU access:
#   docker run --rm --device /dev/dri:/dev/dri debian:bookworm-slim \
#     bash -c "apt update && apt install -y vainfo && vainfo"
#
# =============================================================================
# VOLUMES
# =============================================================================
# Named volumes (recommended for easier permission management)
# To backup: docker run --rm -v xg2g-data:/data -v $(pwd):/backup alpine tar czf /backup/xg2g-backup.tar.gz -C /data .
# To restore: docker run --rm -v xg2g-data:/data -v $(pwd):/backup alpine tar xzf /backup/xg2g-backup.tar.gz -C /data
volumes:
  xg2g-data:
