#!/bin/bash
# Mock FFmpeg that generates HLS content
# Usage: ./mock_ffmpeg <args...>

# Parse args to find output directory
# Args usually end with <out_dir>/index.m3u8.tmp
# We need to extract the directory.

# Simple logic: last argument is playlist path
LAST_ARG="${@: -1}"
PLAYLIST_DIR=$(dirname "$LAST_ARG")
PLAYLIST_NAME=$(basename "$LAST_ARG") # index.m3u8.tmp

# Ensure directory exists (Runner does this, but good to ensure)
mkdir -p "$PLAYLIST_DIR"

echo "Mock FFmpeg starting in $PLAYLIST_DIR" >&2

# Generate Segment 1
SEG1="$PLAYLIST_DIR/seg_000001.ts"
echo "fake-ts-content-1" > "$SEG1"

# Generate Playlist (Tmp)
# Standard HLS M3U8
cat <<EOF > "$PLAYLIST_DIR/$PLAYLIST_NAME"
#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:6
#EXT-X-MEDIA-SEQUENCE:1
#EXTINF:6.000,
seg_000001.ts
EOF

echo "Generated segment 1 and playlist" >&2

# Sleep to simulate live stream
sleep 2

# Generate Segment 2
SEG2="$PLAYLIST_DIR/seg_000002.ts"
echo "fake-ts-content-2" > "$SEG2"

# Update Playlist
cat <<EOF > "$PLAYLIST_DIR/$PLAYLIST_NAME"
#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:6
#EXT-X-MEDIA-SEQUENCE:2
#EXTINF:6.000,
seg_000001.ts
#EXTINF:6.000,
seg_000002.ts
EOF

echo "Generated segment 2 and updated playlist" >&2

# Keep running
while true; do
  sleep 10
done
